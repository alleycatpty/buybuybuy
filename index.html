<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Â∞èÂûãÂúòË≥ºÁ∂≤Á´ô</title>
    <style>
        :root {
            --primary: #ff8a5b;
            --accent: #ffd7a3;
            --bg: #fff9f3;
            --muted: #666;
            --card: #fff;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: "Segoe UI", "Noto Sans TC", Arial;
            background: var(--bg);
            color: #222;
        }

        /* ================= HEADER ================= */
        header {
            background: var(--primary);
            color: #fff;
            padding: 14px;
            text-align: center;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 120;
        }

        .rules {
            background: var(--accent);
            color: #222;
            font-size: 14px;
            padding: 6px;
            text-align: center;
        }

        /* ================= TOPBAR ================= */
        .topbar {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            background: var(--accent);
            padding: 10px;
            position: sticky;
            top: 72px;
            z-index: 115;
        }

        .topbar button {
            background: #fff;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            position: relative;
        }

        .topbar button:hover {
            background: var(--primary);
            color: #fff
        }

        .cart-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: red;
            color: #fff;
            font-size: 12px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
        }

        /* ================= CONTROLS ================= */
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            padding: 12px;
            position: sticky;
            top: 106px;
            z-index: 110;
        }

        .multi-select {
            position: relative;
            width: 260px;
        }

        .multi-select .label {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #fff;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .multi-select .panel {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 6px);
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            display: none;
            max-height: 220px;
            overflow: auto;
            z-index: 130;
        }

        .multi-select .panel label {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
        }

        .multi-select .panel label:hover {
            background: #f8f8f8;
        }

        /* ================= PRODUCT LIST ================= */
        .container {
            max-width: 1100px;
            margin: 18px auto;
            padding: 0 12px;
        }

        .table-header {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 90px 110px 120px;
            gap: 8px;
            align-items: center;
            background: linear-gradient(90deg, #fff7f0, #fff3e8);
            padding: 10px 12px;
            font-weight: 700;
            border-radius: 8px;
            position: sticky;
            top: 158px;
            z-index: 100;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.03);
        }

        .table-header div {
            text-align: center;
            font-size: 13px;
            color: var(--muted)
        }

        .category-block {
            margin-top: 18px;
            background: var(--card);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #f2e6db;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03)
        }

        .product {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 90px 110px 120px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
        }

        .product+.product {
            border-top: 1px dashed #f0e6db
        }

        .product img {
            width: 76px;
            height: 76px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            margin: auto;
            border: 1px solid #eee;
        }

        .qty-input {
            width: 72px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center
        }

        .btn-add {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700
        }

        .btn-add:hover {
            opacity: .95
        }

        /* ================= PANELS ================= */
        .panel {
            display: none;
            position: fixed;
            right: 18px;
            top: 100px;
            width: 420px;
            max-height: 78vh;
            overflow: auto;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            z-index: 220;
        }

        .panel.open {
            display: block
        }

        .panel h3 {
            margin: 4px 0 8px;
            font-size: 18px;
            color: var(--primary)
        }

        .cart-item {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: #fff8f3;
            margin-bottom: 8px
        }

        .cart-item img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 6px
        }

        .cart-item .name {
            font-weight: 600
        }

        .cart-item .small {
            color: var(--muted);
            font-size: 13px
        }

        .overlay {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.36);
            z-index: 210
        }

        .overlay.show {
            display: block
        }

        .img-preview {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 300
        }

        .img-preview img {
            max-width: 92%;
            max-height: 92%;
            border-radius: 10px
        }

        .wish-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            z-index: 310;
            width: 340px
        }

        .wish-popup h4 {
            margin: 0 0 8px
        }

        .records-list {
            max-height: 400px;
            overflow: auto;
            margin-top: 8px
        }

        .order-card {
            background: #fff8f3;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #f2e6db
        }

        @media(max-width:900px) {
            .panel {
                right: 8px;
                left: 8px;
                width: auto
            }
        }
    </style>
</head>

<body>

    <!-- HEADER & RULES -->
    <header>Â∞èÂûãÂúòË≥ºÁ∂≤Á´ô</header>
    <div class="rules" id="rules">ËºâÂÖ•‰∏≠...</div>

    <!-- TOPBAR -->
    <div class="topbar">
        <button id="openWishBtn">üå† Ë®±È°òÊ∏ÖÂñÆ</button>
        <button id="openCartBtn">üõí Ë≥ºÁâ©Ëªä <span id="cartCount" class="cart-count" style="display:none">0</span></button>
        <button id="openRecordsBtn">üßæ Ë≥ºÁâ©ËªäÁ¥ÄÈåÑ</button>
    </div>

    <!-- CONTROLS -->
    <div class="controls container">
        <div class="multi-select" id="categoryMulti">
            <div class="label" id="categoryLabel">ÂàÜÈ°ûÁØ©ÈÅ∏ ¬∑ Â§öÈÅ∏ <span id="selectedCount" style="margin-left:auto;color:var(--muted);font-weight:600">ÂÖ®ÈÉ®</span></div>
            <div class="panel" id="categoryPanel"></div>
        </div>
        <input type="text" id="searchBox" placeholder="ÊêúÂ∞ãÂïÜÂìÅÂêçÁ®±..." style="padding:8px;border-radius:8px;border:1px solid #ddd;width:320px">
    </div>

    <!-- PRODUCT AREA -->
    <div class="container">
        <div class="table-header">
            <div>ÂúñÁâá</div>
            <div>ÂêçÁ®±</div>
            <div>ÂìÅÁâå</div>
            <div>ÂÉπÊ†º</div>
            <div>Êï∏Èáè</div>
            <div>Êìç‰Ωú</div>
        </div>
        <div id="productArea"></div>
    </div>

    <!-- CART PANEL -->
<div class="panel" id="cartPanel">
  <form id="orderForm" target="hidden_iframe">
      <h3>Ë≥ºÁâ©Ëªä</h3>
      <div id="cartItemsContainer"></div>

      <input type="hidden" name="action" value="submitOrder">
      <input type="hidden" name="cart" id="cartInput">

      <input name="checkoutName" id="checkoutName" placeholder="ÂßìÂêç" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">
      <input name="checkoutPhone" id="checkoutPhone" placeholder="ÈõªË©±" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">
      <input name="checkoutEmail" id="checkoutEmail" placeholder="Email" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">

      <div style="display:flex;justify-content:flex-end;gap:8px">
          <button type="button" class="btn-ghost" id="closeCart">ÈóúÈñâ</button>
          <button type="submit" class="btn-primary">ÈÄÅÂá∫Ë®ÇÂñÆ</button>
      </div>
  </form>
</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>

    <!-- RECORDS PANEL -->
    <div class="panel" id="recordsPanel">
        <h3>Ë≥ºÁâ©Á¥ÄÈåÑ</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="recordsEmail" placeholder="Ëº∏ÂÖ• Email Êü•Ë©¢" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd">
            <button class="btn-primary" id="lookupRecords">Êü•Ë©¢</button>
        </div>
        <div class="records-list" id="recordsList"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button class="btn-ghost" id="closeRecords">ÈóúÈñâ</button>
        </div>
    </div>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay"></div>

    <!-- WISH POPUP -->
    <div class="wish-popup" id="wishPopup">
        <h4>Ë®±È°òÊ∏ÖÂñÆ ‚ú®</h4>
        <input id="wishImg" placeholder="ÂúñÁâáÈÄ£Áµê (https://...)">
        <input id="wishProduct" placeholder="Áî¢ÂìÅÂêçÁ®±">
        <input id="wishPerson" placeholder="Ë®±È°ò‰∫∫ÂßìÂêç">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn-ghost" id="closeWish">ÈóúÈñâ</button>
            <button class="btn-primary" id="submitWishBtn">Êèê‰∫§</button>
        </div>
    </div>

    <!-- IMAGE PREVIEW -->
    <div class="img-preview" id="imgPreview"><img src="" alt=""></div>

    <script>
        /* ===================== CONFIG ======================= */
        // ‚úÖ Ë®≠ÂÆöÂçÄÔºöÊîæÂõ∫ÂÆö‰∏çËÆäÁöÑË®≠ÂÆöÂÄº
        // GAS_URLÔºöÊåáÂêë Google Apps Script Web App ÁöÑÁ∂≤ÂùÄ
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzue0Tf2llwjtmzaxN1peGdZ5i3mPKEQ_iD9W-zu6VXwfk1M_7flUGn5smFvUYtlbp8/exec";


        /* ===================== GLOBAL STATE ======================= */
        // ‚úÖ ÂÖ®ÂüüÁãÄÊÖãÔºåÁî®‰æÜÂú®Â§öÂÄãÂáΩÂºè‰πãÈñìÂÖ±Áî®Ë≥áÊñô
        let products = []; // Â≠òÊîæÂæû GAS ÂèñÂæóÁöÑÂïÜÂìÅÊ∏ÖÂñÆ
        let cart = []; // ‰ΩøÁî®ËÄÖÁõÆÂâçÂä†ÂÖ•Ë≥ºÁâ©ËªäÁöÑÂïÜÂìÅÔºàÊú¨Âú∞Ë®òÊÜ∂È´îÂÖßÁöÑÊö´Â≠òË≥áÊñôÔºâ

        /* ===================== INIT ======================= */
        // ‚úÖ ÂàùÂßãÂåñÈÇèËºØÔºöÁ≠âÈ†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÊâçÂü∑Ë°å
        window.addEventListener("DOMContentLoaded", () => {
            console.log("[INIT] È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÔºåÈñãÂßãÂàùÂßãÂåñ...");
            // 1Ô∏è‚É£ ËÆÄÂèñÂúòË≥ºË¶èÂâáÔºà‰æãÂ¶ÇÔºöÊªøÂπæ‰ª∂ÂÖçÈÅã„ÄÅÂá∫Ë≤®Êó•„ÄÅ‰ªòÊ¨æÊñπÂºèÁ≠âÔºâ
            loadRules();

            // 2Ô∏è‚É£ ËÆÄÂèñÂïÜÂìÅÊ∏ÖÂñÆÔºàÂæûË©¶ÁÆóË°®Êàñ GAS ÂÇ≥ÂõûÔºâ
            loadProducts();

            // 3Ô∏è‚É£ Á∂ÅÂÆöÊåâÈàï„ÄÅËº∏ÂÖ•Ê°Ü„ÄÅË≥ºÁâ©ËªäÊåâÈàïÁ≠â‰∫íÂãï‰∫ã‰ª∂
            bindEvents();
        });

        /* ===================== FETCH HELPERS ======================= */
        // ‚úÖ ÈÄöÁî® API ÂëºÂè´ÂáΩÂºè
        // ÊâÄÊúâÂâçÁ´ØËàá GAS ÁöÑË≥áÊñô‰∫§ÊèõÈÉΩÁ∂ìÁî±ÈÄôË£°ÈÄ≤Ë°å„ÄÇ
        // payload ÊòØ‰∏ÄÂÄãÁâ©‰ª∂ÔºåËá≥Â∞ëË¶ÅÊúâ action Â±¨ÊÄßÔºà‰æãÂ¶Ç {action: "getProducts"}Ôºâ
        async function callAPI(payload) {
            console.log(`[API] ÂëºÂè´ GAS (${GAS_URL})ÔºåÂÇ≥ÈÄÅË≥áÊñô:`, payload);
            console.log(`[API] ÂëºÂè´ GAS (${GAS_URL})ÔºåÂÇ≥ÈÄÅË≥áÊñô:`, payload);

            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                console.log("[API] Êî∂Âà∞ÂõûÊáâÁãÄÊÖãÁ¢º:", res.status);

                if (!res.ok) {
                    console.error("[API] ÂõûÊáâÈåØË™§:", res.status, res.statusText);
                    throw new Error(`API ÂõûÊáâÈåØË™§: ${res.status}`);
                }

                const json = await res.json();
                console.log("[API] ÂõûÂÇ≥ JSON:", json);
                return json;

            } catch (err) {
                console.error("[API] ÂëºÂè´Â§±Êïó:", err);
                throw err; // ÂÜçÂæÄ‰∏ä‰∏üÂá∫ÈåØË™§ËÆìÂëºÂè´ËÄÖËôïÁêÜ
            }
        }

        /* ===================== LOAD RULES ======================= */
        // ‚úÖ Âæû GAS ÂèñÂæóÂúòË≥ºË¶èÂâáÊñáÂ≠óÔºå‰∏¶È°ØÁ§∫Âú®È†ÅÈù¢‰∏ä
        async function loadRules() {
            try {
                console.log("[RULES] ËºâÂÖ•‰∏≠...");
                const res = await fetch(`${GAS_URL}?action=getRules`);
                const data = await res.json();
                console.log("[RULES] Êî∂Âà∞Ë≥áÊñô:", data);
                document.getElementById("rules").textContent = data.rules || "ÁÑ°Ë≥áÊñô";
            } catch (err) {
                console.error("[RULES] ËºâÂÖ•Â§±Êïó:", err);
                document.getElementById("rules").textContent = "ËÆÄÂèñÂ§±Êïó";
            }
        }

        /* ===================== LOAD PRODUCTS ======================= */
        // ‚úÖ Âæû GAS ÂèñÂæóÂïÜÂìÅË≥áÊñôÔºà‰æãÂ¶ÇÔºöÂêçÁ®±„ÄÅÂÉπÊ†º„ÄÅÂúñÁâá„ÄÅÂ∫´Â≠òÁ≠âÔºâ
        async function loadProducts() {
            try {
                console.log("[PRODUCTS] ËºâÂÖ•‰∏≠...");
                const res = await fetch(`${GAS_URL}?action=getProducts`);
                const data = await res.json();
                console.log("[PRODUCTS] Êî∂Âà∞Ë≥áÊñô:", data);

                products = Array.isArray(data) ? data : (data.products || []);
                console.log("[PRODUCTS] ÂØ¶ÈöõÊ∏≤ÊüìÁ≠ÜÊï∏:", products.length);
                renderProducts(products);
            } catch (err) {
                console.error("[PRODUCTS] ËºâÂÖ•Â§±Êïó:", err);
            }
        }


        /* ===================== renderProducts ======================= */
        function renderProducts(items) {
            console.log("[RENDER] ÈñãÂßãÊ∏≤ÊüìÂïÜÂìÅÔºåÂÖ±", items.length, "Á≠Ü");

            const container = document.getElementById("productList");
            if (!container) {
                console.error("[RENDER] Êâæ‰∏çÂà∞ #productList ÂÖÉÁ¥†ÔºÅ");
                return;
            }

            container.innerHTML = "";

            if (!items.length) {
                container.innerHTML = "<p>ÁõÆÂâçÊ≤íÊúâÂïÜÂìÅË≥áÊñô„ÄÇ</p>";
                return;
            }

            items.forEach((p, index) => {
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
            <img src="${p.img || ""}" alt="${p.name || "ÂïÜÂìÅ"}">
            <h3>${p.name || "Êú™ÂëΩÂêçÂïÜÂìÅ"}</h3>
            <p>${p.price ? p.price + " ÂÖÉ" : "Êú™Ë®≠ÂÆöÂÉπÊ†º"}</p>
            <p>${p.brand || ""} | ${p.category || ""}</p>
            <button data-index="${index}">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
        `;
                container.appendChild(card);
            });

            console.log("[RENDER] ÂïÜÂìÅÊ∏≤ÊüìÂÆåÊàê");
        }



        /* ===================== bindEvents ======================= */
        // Á∂ÅÂÆöÈ†ÅÈù¢ÊåâÈàï‰∫ã‰ª∂Ôºå‰æãÂ¶ÇË≥ºÁâ©ËªäÊìç‰Ωú Áõ£ËÅΩÊØèÂÄãÂïÜÂìÅ„ÄåÂä†ÂÖ•Ë≥ºÁâ©Ëªä„ÄçÊåâÈàï
        function bindEvents() {
            console.log("[EVENT] ÈñãÂßãÁ∂ÅÂÆö‰∫ã‰ª∂...");

            const productList = document.getElementById("productList");
            if (!productList) {
                console.warn("[EVENT] Êâæ‰∏çÂà∞ #productList ÂÖÉÁ¥†ÔºåÁÑ°Ê≥ïÁ∂ÅÂÆö‰∫ã‰ª∂");
                return;
            }

            // ‰∫ã‰ª∂ÂßîÊ¥æÔºöÁõ£ËÅΩÊï¥ÂÄãÂïÜÂìÅÂàóË°®ÁöÑÊåâÈàïÈªûÊìä
            productList.addEventListener("click", e => {
                // ‚ö†Ô∏è Ê≥®ÊÑèË¶ÅÂíå renderProducts ÁöÑ data-* Â±¨ÊÄß‰∏ÄËá¥
                if (e.target.matches("button[data-index]")) {
                    const index = parseInt(e.target.dataset.index, 10);
                    console.log(`[CART] ‰ΩøÁî®ËÄÖÈªûÊìäÂä†ÂÖ•Ë≥ºÁâ©ËªäÔºåÂïÜÂìÅÁ¥¢Âºï=${index}`);
                    addToCart(index);
                }
            });

            console.log("[EVENT] ‰∫ã‰ª∂Á∂ÅÂÆöÂÆåÊàê");
        }

        /* ===================== ADD TO CART ======================= */
        // Â∞áÂïÜÂìÅÂä†ÂÖ•Ë≥ºÁâ©Ëªä
        function addToCart(index) {
            const product = products[index];
            if (!product) {
                console.warn("[CART] Êâæ‰∏çÂà∞ÂïÜÂìÅÔºåÁ¥¢Âºï:", index);
                return;
            }

            cart.push(product); // Âä†ÂÖ•Ë≥ºÁâ©ËªäÈô£Âàó
            console.log("[CART] Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä:", product);
            console.log("[CART] Ë≥ºÁâ©ËªäÁõÆÂâçÂÖ±Êúâ", cart.length, "‰ª∂ÂïÜÂìÅ");
        }


        /* ===================== RENDER PRODUCTS ======================= */
        function renderProducts(list) {
            const area = document.getElementById("productArea");
            area.innerHTML = "";
            list.forEach(p => {
                const el = document.createElement("div");
                el.className = "product";
                el.innerHTML = `
      <img src="${p.img}" onclick="showImagePreview('${p.img}')">
      <div>${p.name}</div>
      <div>${p.brand||'-'}</div>
      <div>$${p.price}</div>
      <div><input type="number" class="qty-input" id="qty_${p.code}" min="1" value="1"></div>
      <div style="text-align:center"><button class="btn-add" onclick="addToCart('${p.code}')">Âä†ÂÖ•</button></div>
    `;
                area.appendChild(el);
            });
        }
/* ===================== CART ======================= */

/* Âä†ÂÖ•ÂïÜÂìÅÂà∞Ë≥ºÁâ©Ëªä */
function addToCart(code) {
    const p = products.find(x => x.code === code);
    if (!p) return;
    const qty = parseInt(document.getElementById(`qty_${code}`)?.value) || 1;
    const existing = cart.find(c => c.code === code);
    if (existing) existing.qty += qty;
    else cart.push({ ...p, qty });
    console.log("[CART] Âä†ÂÖ•Ë≥ºÁâ©Ëªä:", code, "Êï∏Èáè:", qty);
    updateCartCount();
    renderCart(); // ÊØèÊ¨°Âä†ÂÖ•ÂæåÈáçÊñ∞Ê∏≤Êüì
}

/* Êõ¥Êñ∞Ë≥ºÁâ©ËªäÊï∏ÈáèÈ°ØÁ§∫ */
function updateCartCount() {
    const count = cart.reduce((s, i) => s + i.qty, 0);
    const el = document.getElementById("cartCount");
    if (count > 0) {
        el.style.display = "flex";
        el.textContent = count;
    } else el.style.display = "none";
}

/* Ê∏≤ÊüìË≥ºÁâ©ËªäÂàóË°® */
function renderCart() {
    const box = document.getElementById("cartItemsContainer");
    console.log("[CART] Ê∏≤ÊüìË≥ºÁâ©ËªäÔºåÂïÜÂìÅÊï∏Èáè:", cart.length);

    if (!box) {
        console.error("[CART] Êâæ‰∏çÂà∞ #cartItemsContainer");
        return;
    }

    if (cart.length > 0) {
        box.innerHTML = cart.map(i => `
        <div class="cart-item" data-code="${i.code}" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <img src="${i.img}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;margin-right:8px;">
            <div style="flex:1;">
                <div class="name" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${i.name}</span>
                    <button class="btn-remove" style="background:none;border:none;color:red;cursor:pointer;">Âà™Èô§</button>
                </div>
                <div class="small" style="display:flex;align-items:center;gap:8px;">
                    <span>Êï∏ÈáèÔºö</span>
                    <input type="number" class="cart-qty" value="${i.qty}" min="1" style="width:50px;">
                    <span>¬∑ $${i.price * i.qty}</span>
                </div>
            </div>
        </div>
        `).join("");
        console.log("[CART] ÂïÜÂìÅÊ∏≤ÊüìÂÆåÊàê");
    } else {
        box.innerHTML = "<p>Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>";
        console.log("[CART] Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ");
    }

    // üîπ Á∂ÅÂÆöÂà™Èô§‰∫ã‰ª∂
    const removeButtons = box.querySelectorAll(".btn-remove");
    removeButtons.forEach(btn => {
        btn.onclick = () => {
            const code = btn.closest(".cart-item").dataset.code;
            cart = cart.filter(c => c.code !== code);
            console.log("[CART] Â∑≤Âà™Èô§ÂïÜÂìÅ:", code);
            updateCartCount();
            renderCart(); // Âà™Èô§ÂæåÈáçÊñ∞Ê∏≤Êüì
        };
    });

    // üîπ Á∂ÅÂÆö‰øÆÊîπÊï∏Èáè‰∫ã‰ª∂
    const qtyInputs = box.querySelectorAll(".cart-qty");
    qtyInputs.forEach(input => {
        input.onchange = () => {
            const code = input.closest(".cart-item").dataset.code;
            const item = cart.find(c => c.code === code);
            if (!item) return;
            const newQty = parseInt(input.value) || 1;
            item.qty = newQty;
            console.log("[CART] ‰øÆÊîπÊï∏Èáè:", code, "Êñ∞Êï∏Èáè:", newQty);
            updateCartCount();
            renderCart(); // Êõ¥Êñ∞ÂæåÈáçÊñ∞Ê∏≤Êüì
        };
    });
}

/* ===================== ORDER SUBMIT ======================= */
async function submitOrder() {
    const name = document.getElementById("checkoutName").value.trim();
    const phone = document.getElementById("checkoutPhone").value.trim();
    const email = document.getElementById("checkoutEmail").value.trim();
    if (!name || !phone || !email || cart.length === 0) {
        alert("Ë´ãÂÆåÊï¥Â°´ÂØ´Ë≥áÊñôËàáÈÅ∏ÊìáÂïÜÂìÅ");
        return;
    }

const payload = {
    action: "submitOrder",
    order: { name, phone, email, cart }  // Áî® order ÂåÖËµ∑‰æÜ
};
    const res = await callAPI(payload);
    alert(res.message || "Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫");

    // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
    cart = [];
    updateCartCount();
    renderCart();
    document.getElementById("cartPanel").classList.remove("open");
}

        /* ===================== WISH ======================= */
        async function submitWish() {
            const img = document.getElementById("wishImg").value.trim();
            const product = document.getElementById("wishProduct").value.trim();
            const person = document.getElementById("wishPerson").value.trim();
            if (!product || !person) {
                alert("Ë´ãÂ°´ÂØ´Áî¢ÂìÅÂêçÁ®±ËàáÂßìÂêç");
                return;
            }
            const res = await callAPI({
                action: "submitWish",
                img,
                product,
                person
            });
            alert(res.message || "Â∑≤Êèê‰∫§");
            closeWish();
        }

        /* ===================== RECORDS ======================= */
        async function lookupRecords() {
            const email = document.getElementById("recordsEmail").value.trim();
            if (!email) {
                alert("Ë´ãËº∏ÂÖ• Email");
                return;
            }
            const res = await callAPI({
                action: "getRecords",
                email
            });
            const box = document.getElementById("recordsList");
            box.innerHTML = res.records?.map(o => `
    <div class="order-card">
      <div><b>Êó•ÊúüÔºö</b>${o.date}</div>
      <div class="meta">${o.items}</div>
    </div>
  `).join("") || "<p>Êü•ÁÑ°Á¥ÄÈåÑ</p>";
        }

        /* ===================== IMAGE PREVIEW ======================= */
        function showImagePreview(src) {
            const box = document.getElementById("imgPreview");
            box.style.display = "flex";
            box.querySelector("img").src = src;
        }
        document.getElementById("imgPreview").addEventListener("click", () => document.getElementById("imgPreview").style.display = "none");

        /* ===================== EVENT BIND ======================= */
        function bindEvents() {
            document.getElementById("openCartBtn").onclick = () => {
                renderCart();
                openPanel("cartPanel");
            };
            document.getElementById("closeCart").onclick = () => closePanel("cartPanel");
            document.getElementById("submitOrderBtn").onclick = submitOrder;
            document.getElementById("openWishBtn").onclick = () => openPopup("wishPopup");
            document.getElementById("closeWish").onclick = closeWish;
            document.getElementById("submitWishBtn").onclick = submitWish;
            document.getElementById("openRecordsBtn").onclick = () => openPanel("recordsPanel");
            document.getElementById("closeRecords").onclick = () => closePanel("recordsPanel");
            document.getElementById("lookupRecords").onclick = lookupRecords;
        }

        /* ===================== PANEL / POPUP ======================= */
        function openPanel(id) {
            document.getElementById(id).classList.add("open");
            document.getElementById("overlay").classList.add("show");
        }

        function closePanel(id) {
            document.getElementById(id).classList.remove("open");
            document.getElementById("overlay").classList.remove("show");
        }

        function openPopup(id) {
            document.getElementById(id).style.display = "block";
            document.getElementById("overlay").classList.add("show");
        }

        function closeWish() {
            document.getElementById("wishPopup").style.display = "none";
            document.getElementById("overlay").classList.remove("show");
        }
    </script>
</body>

</html>
