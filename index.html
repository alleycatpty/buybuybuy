<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å°å‹åœ˜è³¼ç¶²ç«™</title>
    <style>
        :root {
            --primary: #ff8a5b;
            --accent: #ffd7a3;
            --bg: #fff9f3;
            --muted: #666;
            --card: #fff;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: "Segoe UI", "Noto Sans TC", Arial;
            background: var(--bg);
            color: #222;
        }

        /* ================= HEADER ================= */
        header {
            background: var(--primary);
            color: #fff;
            padding: 14px;
            text-align: center;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 120;
        }

        .rules {
            background: var(--accent);
            color: #222;
            font-size: 14px;
            padding: 6px;
            text-align: center;
        }

        /* ================= TOPBAR ================= */
        .topbar {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            background: var(--accent);
            padding: 10px;
            position: sticky;
            top: 72px;
            z-index: 115;
        }

        .topbar button {
            background: #fff;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            position: relative;
        }

        .topbar button:hover {
            background: var(--primary);
            color: #fff
        }

        .cart-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: red;
            color: #fff;
            font-size: 12px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
        }

        /* ================= CONTROLS ================= */
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            padding: 12px;
            position: sticky;
            top: 106px;
            z-index: 110;
        }

        .multi-select {
            position: relative;
            width: 260px;
        }

        .multi-select .label {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #fff;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .multi-select .panel {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 6px);
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            display: none;
            max-height: 220px;
            overflow: auto;
            z-index: 130;
        }

        .multi-select .panel label {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
        }

        .multi-select .panel label:hover {
            background: #f8f8f8;
        }

        /* ================= PRODUCT LIST ================= */
        .container {
            max-width: 1100px;
            margin: 18px auto;
            padding: 0 12px;
        }

        .table-header {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 90px 110px 120px;
            gap: 8px;
            align-items: center;
            background: linear-gradient(90deg, #fff7f0, #fff3e8);
            padding: 10px 12px;
            font-weight: 700;
            border-radius: 8px;
            position: sticky;
            top: 158px;
            z-index: 100;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.03);
        }

        .table-header div {
            text-align: center;
            font-size: 13px;
            color: var(--muted)
        }

        .category-block {
            margin-top: 18px;
            background: var(--card);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #f2e6db;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03)
        }

        .product {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 90px 110px 120px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
        }

        .product+.product {
            border-top: 1px dashed #f0e6db
        }

        .product img {
            width: 76px;
            height: 76px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            margin: auto;
            border: 1px solid #eee;
        }

        .qty-input {
            width: 72px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center
        }

        .btn-add {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700
        }

        .btn-add:hover {
            opacity: .95
        }

        /* ================= PANELS ================= */
        .panel {
            display: none;
            position: fixed;
            right: 18px;
            top: 100px;
            width: 420px;
            max-height: 78vh;
            overflow: auto;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            z-index: 220;
        }

        .panel.open {
            display: block
        }

        .panel h3 {
            margin: 4px 0 8px;
            font-size: 18px;
            color: var(--primary)
        }

        .cart-item {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: #fff8f3;
            margin-bottom: 8px
        }

        .cart-item img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 6px
        }

        .cart-item .name {
            font-weight: 600
        }

        .cart-item .small {
            color: var(--muted);
            font-size: 13px
        }

        .overlay {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.36);
            z-index: 210
        }

        .overlay.show {
            display: block
        }

        .img-preview {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 300
        }

        .img-preview img {
            max-width: 92%;
            max-height: 92%;
            border-radius: 10px
        }

        .wish-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            z-index: 310;
            width: 340px
        }

        .wish-popup h4 {
            margin: 0 0 8px
        }

        .records-list {
            max-height: 400px;
            overflow: auto;
            margin-top: 8px
        }

        .order-card {
            background: #fff8f3;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #f2e6db
        }

        @media(max-width:900px) {
            .panel {
                right: 8px;
                left: 8px;
                width: auto
            }
        }
    </style>
</head>

<body>

    <!-- HEADER & RULES -->
    <header>å°å‹åœ˜è³¼ç¶²ç«™</header>
    <div class="rules" id="rules">è¼‰å…¥ä¸­...</div>

    <!-- TOPBAR -->
    <div class="topbar">
        <button id="openWishBtn">ğŸŒ  è¨±é¡˜æ¸…å–®</button>
        <button id="openCartBtn">ğŸ›’ è³¼ç‰©è»Š <span id="cartCount" class="cart-count" style="display:none">0</span></button>
        <button id="openRecordsBtn">ğŸ§¾ è³¼ç‰©è»Šç´€éŒ„</button>
    </div>

    <!-- CONTROLS -->
    <div class="controls container">
        <div class="multi-select" id="categoryMulti">
            <div class="label" id="categoryLabel">åˆ†é¡ç¯©é¸ Â· å¤šé¸ <span id="selectedCount" style="margin-left:auto;color:var(--muted);font-weight:600">å…¨éƒ¨</span></div>
            <div class="panel" id="categoryPanel"></div>
        </div>
        <input type="text" id="searchBox" placeholder="æœå°‹å•†å“åç¨±..." style="padding:8px;border-radius:8px;border:1px solid #ddd;width:320px">
    </div>

    <!-- PRODUCT AREA -->
    <div class="container">
        <div class="table-header">
            <div>åœ–ç‰‡</div>
            <div>åç¨±</div>
            <div>å“ç‰Œ</div>
            <div>åƒ¹æ ¼</div>
            <div>æ•¸é‡</div>
            <div>æ“ä½œ</div>
        </div>
        <div id="productArea"></div>
    </div>

    <!-- CART PANEL -->
<div class="panel" id="cartPanel">
  <form id="orderForm" target="hidden_iframe">
      <h3>è³¼ç‰©è»Š</h3>
      <div id="cartItemsContainer"></div>

      <input type="hidden" name="action" value="submitOrder">
      <input type="hidden" name="cart" id="cartInput">

      <input name="checkoutName" id="checkoutName" placeholder="å§“å" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">
      <input name="checkoutPhone" id="checkoutPhone" placeholder="é›»è©±" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">
      <input name="checkoutEmail" id="checkoutEmail" placeholder="Email" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">

      <div style="display:flex;justify-content:flex-end;gap:8px">
          <button type="button" class="btn-ghost" id="closeCart">é—œé–‰</button>
          <button type="submit" class="btn-primary">é€å‡ºè¨‚å–®</button>
      </div>
  </form>
</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>

    <!-- RECORDS PANEL -->
    <div class="panel" id="recordsPanel">
        <h3>è³¼ç‰©ç´€éŒ„</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="recordsEmail" placeholder="è¼¸å…¥ Email æŸ¥è©¢" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd">
            <button class="btn-primary" id="lookupRecords">æŸ¥è©¢</button>
        </div>
        <div class="records-list" id="recordsList"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button class="btn-ghost" id="closeRecords">é—œé–‰</button>
        </div>
    </div>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay"></div>

    <!-- WISH POPUP -->
    <div class="wish-popup" id="wishPopup">
        <h4>è¨±é¡˜æ¸…å–® âœ¨</h4>
        <input id="wishImg" placeholder="åœ–ç‰‡é€£çµ (https://...)">
        <input id="wishProduct" placeholder="ç”¢å“åç¨±">
        <input id="wishPerson" placeholder="è¨±é¡˜äººå§“å">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn-ghost" id="closeWish">é—œé–‰</button>
            <button class="btn-primary" id="submitWishBtn">æäº¤</button>
        </div>
    </div>

    <!-- IMAGE PREVIEW -->
    <div class="img-preview" id="imgPreview"><img src="" alt=""></div>

    <script>
        /* ===================== CONFIG ======================= */
        // âœ… è¨­å®šå€ï¼šæ”¾å›ºå®šä¸è®Šçš„è¨­å®šå€¼
        // GAS_URLï¼šæŒ‡å‘ Google Apps Script Web App çš„ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzue0Tf2llwjtmzaxN1peGdZ5i3mPKEQ_iD9W-zu6VXwfk1M_7flUGn5smFvUYtlbp8/exec";


        /* ===================== GLOBAL STATE ======================= */
        // âœ… å…¨åŸŸç‹€æ…‹ï¼Œç”¨ä¾†åœ¨å¤šå€‹å‡½å¼ä¹‹é–“å…±ç”¨è³‡æ–™
        let products = []; // å­˜æ”¾å¾ GAS å–å¾—çš„å•†å“æ¸…å–®
        let cart = []; // ä½¿ç”¨è€…ç›®å‰åŠ å…¥è³¼ç‰©è»Šçš„å•†å“ï¼ˆæœ¬åœ°è¨˜æ†¶é«”å…§çš„æš«å­˜è³‡æ–™ï¼‰

        /* ===================== INIT ======================= */
        // âœ… åˆå§‹åŒ–é‚è¼¯ï¼šç­‰é é¢è¼‰å…¥å®Œæˆå¾Œæ‰åŸ·è¡Œ
        window.addEventListener("DOMContentLoaded", () => {
            console.log("[INIT] é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...");
            // 1ï¸âƒ£ è®€å–åœ˜è³¼è¦å‰‡ï¼ˆä¾‹å¦‚ï¼šæ»¿å¹¾ä»¶å…é‹ã€å‡ºè²¨æ—¥ã€ä»˜æ¬¾æ–¹å¼ç­‰ï¼‰
            loadRules();

            // 2ï¸âƒ£ è®€å–å•†å“æ¸…å–®ï¼ˆå¾è©¦ç®—è¡¨æˆ– GAS å‚³å›ï¼‰
            loadProducts();

            // 3ï¸âƒ£ ç¶å®šæŒ‰éˆ•ã€è¼¸å…¥æ¡†ã€è³¼ç‰©è»ŠæŒ‰éˆ•ç­‰äº’å‹•äº‹ä»¶
            bindEvents();
        });

        /* ===================== FETCH HELPERS ======================= */
        // âœ… é€šç”¨ API å‘¼å«å‡½å¼
        // æ‰€æœ‰å‰ç«¯èˆ‡ GAS çš„è³‡æ–™äº¤æ›éƒ½ç¶“ç”±é€™è£¡é€²è¡Œã€‚
        // payload æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œè‡³å°‘è¦æœ‰ action å±¬æ€§ï¼ˆä¾‹å¦‚ {action: "getProducts"}ï¼‰
        async function callAPI(payload) {
            console.log(`[API] å‘¼å« GAS (${GAS_URL})ï¼Œå‚³é€è³‡æ–™:`, payload);
            console.log(`[API] å‘¼å« GAS (${GAS_URL})ï¼Œå‚³é€è³‡æ–™:`, payload);

            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                console.log("[API] æ”¶åˆ°å›æ‡‰ç‹€æ…‹ç¢¼:", res.status);

                if (!res.ok) {
                    console.error("[API] å›æ‡‰éŒ¯èª¤:", res.status, res.statusText);
                    throw new Error(`API å›æ‡‰éŒ¯èª¤: ${res.status}`);
                }

                const json = await res.json();
                console.log("[API] å›å‚³ JSON:", json);
                return json;

            } catch (err) {
                console.error("[API] å‘¼å«å¤±æ•—:", err);
                throw err; // å†å¾€ä¸Šä¸Ÿå‡ºéŒ¯èª¤è®“å‘¼å«è€…è™•ç†
            }
        }

        /* ===================== LOAD RULES ======================= */
        // âœ… å¾ GAS å–å¾—åœ˜è³¼è¦å‰‡æ–‡å­—ï¼Œä¸¦é¡¯ç¤ºåœ¨é é¢ä¸Š
        async function loadRules() {
            try {
                console.log("[RULES] è¼‰å…¥ä¸­...");
                const res = await fetch(`${GAS_URL}?action=getRules`);
                const data = await res.json();
                console.log("[RULES] æ”¶åˆ°è³‡æ–™:", data);
                document.getElementById("rules").textContent = data.rules || "ç„¡è³‡æ–™";
            } catch (err) {
                console.error("[RULES] è¼‰å…¥å¤±æ•—:", err);
                document.getElementById("rules").textContent = "è®€å–å¤±æ•—";
            }
        }

        /* ===================== LOAD PRODUCTS ======================= */
        // âœ… å¾ GAS å–å¾—å•†å“è³‡æ–™ï¼ˆä¾‹å¦‚ï¼šåç¨±ã€åƒ¹æ ¼ã€åœ–ç‰‡ã€åº«å­˜ç­‰ï¼‰
        async function loadProducts() {
            try {
                console.log("[PRODUCTS] è¼‰å…¥ä¸­...");
                const res = await fetch(`${GAS_URL}?action=getProducts`);
                const data = await res.json();
                console.log("[PRODUCTS] æ”¶åˆ°è³‡æ–™:", data);

                products = Array.isArray(data) ? data : (data.products || []);
                console.log("[PRODUCTS] å¯¦éš›æ¸²æŸ“ç­†æ•¸:", products.length);
                renderProducts(products);
            } catch (err) {
                console.error("[PRODUCTS] è¼‰å…¥å¤±æ•—:", err);
            }
        }


        /* ===================== renderProducts ======================= */
        function renderProducts(items) {
            console.log("[RENDER] é–‹å§‹æ¸²æŸ“å•†å“ï¼Œå…±", items.length, "ç­†");

            const container = document.getElementById("productList");
            if (!container) {
                console.error("[RENDER] æ‰¾ä¸åˆ° #productList å…ƒç´ ï¼");
                return;
            }

            container.innerHTML = "";

            if (!items.length) {
                container.innerHTML = "<p>ç›®å‰æ²’æœ‰å•†å“è³‡æ–™ã€‚</p>";
                return;
            }

            items.forEach((p, index) => {
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
            <img src="${p.img || ""}" alt="${p.name || "å•†å“"}">
            <h3>${p.name || "æœªå‘½åå•†å“"}</h3>
            <p>${p.price ? p.price + " å…ƒ" : "æœªè¨­å®šåƒ¹æ ¼"}</p>
            <p>${p.brand || ""} | ${p.category || ""}</p>
            <button data-index="${index}">åŠ å…¥è³¼ç‰©è»Š</button>
        `;
                container.appendChild(card);
            });

            console.log("[RENDER] å•†å“æ¸²æŸ“å®Œæˆ");
        }



        /* ===================== bindEvents ======================= */
        // ç¶å®šé é¢æŒ‰éˆ•äº‹ä»¶ï¼Œä¾‹å¦‚è³¼ç‰©è»Šæ“ä½œ ç›£è½æ¯å€‹å•†å“ã€ŒåŠ å…¥è³¼ç‰©è»Šã€æŒ‰éˆ•
        function bindEvents() {
            console.log("[EVENT] é–‹å§‹ç¶å®šäº‹ä»¶...");

            const productList = document.getElementById("productList");
            if (!productList) {
                console.warn("[EVENT] æ‰¾ä¸åˆ° #productList å…ƒç´ ï¼Œç„¡æ³•ç¶å®šäº‹ä»¶");
                return;
            }

            // äº‹ä»¶å§”æ´¾ï¼šç›£è½æ•´å€‹å•†å“åˆ—è¡¨çš„æŒ‰éˆ•é»æ“Š
            productList.addEventListener("click", e => {
                // âš ï¸ æ³¨æ„è¦å’Œ renderProducts çš„ data-* å±¬æ€§ä¸€è‡´
                if (e.target.matches("button[data-index]")) {
                    const index = parseInt(e.target.dataset.index, 10);
                    console.log(`[CART] ä½¿ç”¨è€…é»æ“ŠåŠ å…¥è³¼ç‰©è»Šï¼Œå•†å“ç´¢å¼•=${index}`);
                    addToCart(index);
                }
            });

            console.log("[EVENT] äº‹ä»¶ç¶å®šå®Œæˆ");
        }

        /* ===================== ADD TO CART ======================= */
        // å°‡å•†å“åŠ å…¥è³¼ç‰©è»Š
        function addToCart(index) {
            const product = products[index];
            if (!product) {
                console.warn("[CART] æ‰¾ä¸åˆ°å•†å“ï¼Œç´¢å¼•:", index);
                return;
            }

            cart.push(product); // åŠ å…¥è³¼ç‰©è»Šé™£åˆ—
            console.log("[CART] å·²åŠ å…¥è³¼ç‰©è»Š:", product);
            console.log("[CART] è³¼ç‰©è»Šç›®å‰å…±æœ‰", cart.length, "ä»¶å•†å“");
        }


        /* ===================== RENDER PRODUCTS ======================= */
        function renderProducts(list) {
            const area = document.getElementById("productArea");
            area.innerHTML = "";
            list.forEach(p => {
                const el = document.createElement("div");
                el.className = "product";
                el.innerHTML = `
      <img src="${p.img}" onclick="showImagePreview('${p.img}')">
      <div>${p.name}</div>
      <div>${p.brand||'-'}</div>
      <div>$${p.price}</div>
      <div><input type="number" class="qty-input" id="qty_${p.code}" min="1" value="1"></div>
      <div style="text-align:center"><button class="btn-add" onclick="addToCart('${p.code}')">åŠ å…¥</button></div>
    `;
                area.appendChild(el);
            });
        }
/* ===================== CART ======================= */

/* åŠ å…¥å•†å“åˆ°è³¼ç‰©è»Š */
function addToCart(code) {
    const p = products.find(x => x.code === code);
    if (!p) return;
    const qty = parseInt(document.getElementById(`qty_${code}`)?.value) || 1;
    const existing = cart.find(c => c.code === code);
    if (existing) existing.qty += qty;
    else cart.push({ ...p, qty });
    console.log("[CART] åŠ å…¥è³¼ç‰©è»Š:", code, "æ•¸é‡:", qty);
    updateCartCount();
    renderCart(); // æ¯æ¬¡åŠ å…¥å¾Œé‡æ–°æ¸²æŸ“
}

/* æ›´æ–°è³¼ç‰©è»Šæ•¸é‡é¡¯ç¤º */
function updateCartCount() {
    const count = cart.reduce((s, i) => s + i.qty, 0);
    const el = document.getElementById("cartCount");
    if (count > 0) {
        el.style.display = "flex";
        el.textContent = count;
    } else el.style.display = "none";
}

/* æ¸²æŸ“è³¼ç‰©è»Šåˆ—è¡¨ */
function renderCart() {
    const box = document.getElementById("cartItemsContainer");
    console.log("[CART] æ¸²æŸ“è³¼ç‰©è»Šï¼Œå•†å“æ•¸é‡:", cart.length);

    if (!box) {
        console.error("[CART] æ‰¾ä¸åˆ° #cartItemsContainer");
        return;
    }

    if (cart.length > 0) {
        box.innerHTML = cart.map(i => `
        <div class="cart-item" data-code="${i.code}" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <img src="${i.img}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;margin-right:8px;">
            <div style="flex:1;">
                <div class="name" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${i.name}</span>
                    <button class="btn-remove" style="background:none;border:none;color:red;cursor:pointer;">åˆªé™¤</button>
                </div>
                <div class="small" style="display:flex;align-items:center;gap:8px;">
                    <span>æ•¸é‡ï¼š</span>
                    <input type="number" class="cart-qty" value="${i.qty}" min="1" style="width:50px;">
                    <span>Â· $${i.price * i.qty}</span>
                </div>
            </div>
        </div>
        `).join("");
        console.log("[CART] å•†å“æ¸²æŸ“å®Œæˆ");
    } else {
        box.innerHTML = "<p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>";
        console.log("[CART] è³¼ç‰©è»Šæ˜¯ç©ºçš„");
    }

    // ğŸ”¹ ç¶å®šåˆªé™¤äº‹ä»¶
    const removeButtons = box.querySelectorAll(".btn-remove");
    removeButtons.forEach(btn => {
        btn.onclick = () => {
            const code = btn.closest(".cart-item").dataset.code;
            cart = cart.filter(c => c.code !== code);
            console.log("[CART] å·²åˆªé™¤å•†å“:", code);
            updateCartCount();
            renderCart(); // åˆªé™¤å¾Œé‡æ–°æ¸²æŸ“
        };
    });

    // ğŸ”¹ ç¶å®šä¿®æ”¹æ•¸é‡äº‹ä»¶
    const qtyInputs = box.querySelectorAll(".cart-qty");
    qtyInputs.forEach(input => {
        input.onchange = () => {
            const code = input.closest(".cart-item").dataset.code;
            const item = cart.find(c => c.code === code);
            if (!item) return;
            const newQty = parseInt(input.value) || 1;
            item.qty = newQty;
            console.log("[CART] ä¿®æ”¹æ•¸é‡:", code, "æ–°æ•¸é‡:", newQty);
            updateCartCount();
            renderCart(); // æ›´æ–°å¾Œé‡æ–°æ¸²æŸ“
        };
    });
}

/* ===================== ORDER SUBMIT ======================= */
async function submitOrder() {
    const name = document.getElementById("checkoutName").value.trim();
    const phone = document.getElementById("checkoutPhone").value.trim();
    const email = document.getElementById("checkoutEmail").value.trim();
    if (!name || !phone || !email || cart.length === 0) {
        alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™èˆ‡é¸æ“‡å•†å“");
        return;
    }

const payload = {
    action: "submitOrder",
    order: { name, phone, email, cart }  // ç”¨ order åŒ…èµ·ä¾†
};
    const res = await callAPI(payload);
    alert(res.message || "è¨‚å–®å·²é€å‡º");

    // æ¸…ç©ºè³¼ç‰©è»Š
    cart = [];
    updateCartCount();
    renderCart();
    document.getElementById("cartPanel").classList.remove("open");
}

        /* ===================== WISH ======================= */
        async function submitWish() {
            const img = document.getElementById("wishImg").value.trim();
            const product = document.getElementById("wishProduct").value.trim();
            const person = document.getElementById("wishPerson").value.trim();
            if (!product || !person) {
                alert("è«‹å¡«å¯«ç”¢å“åç¨±èˆ‡å§“å");
                return;
            }
            const res = await callAPI({
                action: "submitWish",
                img,
                product,
                person
            });
            alert(res.message || "å·²æäº¤");
            closeWish();
        }

        /* ===================== RECORDS ======================= */
        async function lookupRecords() {
            const email = document.getElementById("recordsEmail").value.trim();
            if (!email) {
                alert("è«‹è¼¸å…¥ Email");
                return;
            }
            const res = await callAPI({
                action: "getRecords",
                email
            });
            const box = document.getElementById("recordsList");
            box.innerHTML = res.records?.map(o => `
    <div class="order-card">
      <div><b>æ—¥æœŸï¼š</b>${o.date}</div>
      <div class="meta">${o.items}</div>
    </div>
  `).join("") || "<p>æŸ¥ç„¡ç´€éŒ„</p>";
        }

        /* ===================== IMAGE PREVIEW ======================= */
        function showImagePreview(src) {
            const box = document.getElementById("imgPreview");
            box.style.display = "flex";
            box.querySelector("img").src = src;
        }
        document.getElementById("imgPreview").addEventListener("click", () => document.getElementById("imgPreview").style.display = "none");

        /* ===================== EVENT BIND ======================= */
        function bindEvents() {
            document.getElementById("openCartBtn").onclick = () => {
                renderCart();
                openPanel("cartPanel");
            };
            document.getElementById("closeCart").onclick = () => closePanel("cartPanel");
            document.getElementById("submitOrderBtn").onclick = submitOrder;
            document.getElementById("openWishBtn").onclick = () => openPopup("wishPopup");
            document.getElementById("closeWish").onclick = closeWish;
            document.getElementById("submitWishBtn").onclick = submitWish;
            document.getElementById("openRecordsBtn").onclick = () => openPanel("recordsPanel");
            document.getElementById("closeRecords").onclick = () => closePanel("recordsPanel");
            document.getElementById("lookupRecords").onclick = lookupRecords;
        }

        /* ===================== PANEL / POPUP ======================= */
        function openPanel(id) {
            document.getElementById(id).classList.add("open");
            document.getElementById("overlay").classList.add("show");
        }

        function closePanel(id) {
            document.getElementById(id).classList.remove("open");
            document.getElementById("overlay").classList.remove("show");
        }

        function openPopup(id) {
            document.getElementById(id).style.display = "block";
            document.getElementById("overlay").classList.add("show");
        }

        function closeWish() {
            document.getElementById("wishPopup").style.display = "none";
            document.getElementById("overlay").classList.remove("show");
        }
    </script>
</body>

</html>
