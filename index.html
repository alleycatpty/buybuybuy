<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å°å‹åœ˜è³¼ - å–®é ç‰ˆ</title>
<style>
  :root{
    --primary:#ff8a5b;
    --accent:#ffd7a3;
    --bg:#fff9f3;
    --muted:#666;
    --card:#fff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, "Noto Sans TC", Arial;
    background:var(--bg);
    color:#222;
  }

  /* ================= HEADER ================= */
  header{
    background:var(--primary);
    color:#fff;
    padding:14px;
    text-align:center;
    font-weight:700;
    position:sticky;
    top:0;
    z-index:120;
  }
  .rules{
    background:var(--accent);
    color:#222;
    font-size:14px;
    padding:6px;
    text-align:center;
  }

  /* ================= TOPBAR ================= */
  .topbar{
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
    background:var(--accent);
    padding:10px;
    position:sticky;
    top:72px; /* header+rulesé«˜åº¦ */
    z-index:115;
  }
  .topbar button{
    background:#fff;border:2px solid var(--primary);color:var(--primary);
    padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;position:relative;
  }
  .topbar button:hover{background:var(--primary);color:#fff}
  /* è³¼ç‰©è»Šæ•¸é‡æ¨™ç±¤ */
  .cart-count{
    position:absolute;
    top:-6px; right:-6px;
    background:red;
    color:#fff;
    font-size:12px;
    width:18px; height:18px;
    border-radius:50%;
    display:flex;
    justify-content:center;
    align-items:center;
    font-weight:700;
  }

  /* ================= CONTROLS (ç¯©é¸&æœå°‹) ================= */
  .controls{
    display:flex;
    gap:12px;
    justify-content:center;
    align-items:center;
    padding:12px;
    background:transparent;
    position:sticky;
    top:106px;
    z-index:110;
  }

  /* multi-select dropdown */
  .multi-select{
    position:relative;
    width:260px;
  }
  .multi-select .label{
    display:flex;gap:8px;align-items:center;
    background:#fff;padding:8px;border-radius:8px;border:1px solid #ddd;cursor:pointer;
  }
  .multi-select .label span{color:var(--muted)}
  .multi-select .panel{
    position:absolute;left:0;right:0;top:calc(100% + 6px);
    background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px;box-shadow:0 6px 20px rgba(0,0,0,0.08);
    display:none;max-height:220px;overflow:auto;z-index:130;
  }
  .multi-select .panel label{display:flex;gap:8px;align-items:center;padding:6px;border-radius:6px;cursor:pointer}
  .multi-select .panel label:hover{background:#f8f8f8}

  /* ================= PRODUCT LIST ================= */
  .container{max-width:1100px;margin:18px auto;padding:0 12px;}
  .table-header{
    display:grid;
    grid-template-columns:100px 1fr 1fr 90px 110px 120px;
    gap:8px;
    align-items:center;
    background:linear-gradient(90deg,#fff7f0,#fff3e8);
    padding:10px 12px;
    font-weight:700;
    border-radius:8px;
    position:sticky;
    top:158px;
    z-index:100;
    box-shadow:0 3px 6px rgba(0,0,0,0.03);
  }
  .table-header div{text-align:center;font-size:13px;color:var(--muted)}
  .category-block{margin-top:18px;background:var(--card);border-radius:10px;padding:10px;border:1px solid #f2e6db;box-shadow:0 2px 6px rgba(0,0,0,0.03)}
  .category-title{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .category-title h3{margin:0;color:var(--primary);font-size:16px}
  .category-title span{background:var(--primary);color:#fff;padding:6px 10px;border-radius:20px;font-weight:700;font-size:13px}
  .product{
    display:grid;
    grid-template-columns:100px 1fr 1fr 90px 110px 120px;
    gap:8px;
    align-items:center;
    padding:8px;
    border-radius:8px;
  }
  .product + .product{border-top:1px dashed #f0e6db}
  .product img{width:76px;height:76px;object-fit:cover;border-radius:8px;cursor:pointer;margin:auto;border:1px solid #eee;}
  .meta{font-size:14px;color:#222}
  .muted{font-size:13px;color:var(--muted)}
  .qty-input{width:72px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center}
  .btn-add{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn-add:hover{opacity:.95}

  /* ================= PANELS (cart, wishlist, records, overlay) ================= */
  .panel{
    display:none;
    position:fixed;right:18px;top:100px;width:420px;max-height:78vh;overflow:auto;
    background:white;border-radius:10px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.12);
    z-index:220;
  }
  .panel.open{display:block}
  .panel h3{margin:4px 0 8px;font-size:18px;color:var(--primary)}
  .cart-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fff8f3;margin-bottom:8px}
  .cart-item img{width:56px;height:56px;object-fit:cover;border-radius:6px}
  .cart-item .name{font-weight:600}
  .cart-item .small{color:var(--muted);font-size:13px}
  .cart-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #ddd}

  .overlay{display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.36);z-index:210}
  .overlay.show{display:block}

  .img-preview{display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:300}
  .img-preview img{max-width:92%;max-height:92%;border-radius:10px}

  .wish-popup{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.18);z-index:310;width:340px}
  .wish-popup h4{margin:0 0 8px}

  .records-list{max-height:400px;overflow:auto;margin-top:8px}
  .order-card{background:#fff8f3;padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #f2e6db}
  .order-card .meta{font-size:13px;color:var(--muted)}
  .small-btn{padding:6px 8px;border-radius:8px;border:1px solid #ddd;background:#fff;margin-left:6px;cursor:pointer}

  @media(max-width:900px){
    .panel{right:8px;left:8px;width:auto}
    .table-header,.product{grid-template-columns:80px 1fr 1fr 80px 100px 110px}
  }
  @media(max-width:560px){
    .table-header{display:none}
    .product{grid-template-columns:70px 1fr 1fr 80px 100px;grid-auto-rows:1fr}
    .product > :nth-child(6){display:none}
    .panel{left:8px;right:8px;width:auto;top:90px}
  }

</style>
</head>
<body>

<!-- ================= HEADER & RULES ================= -->
<header>å°å‹åœ˜è³¼ç¶²ç«™</header>
<div class="rules">
  åœ˜è³¼è¦å‰‡ï¼šæ»¿ 3 ä»¶å…é‹ï¼Œä»˜æ¬¾æ–¹å¼ï¼šè½‰å¸³æˆ–è¶…å•†ä»˜æ¬¾ï¼Œå‡ºè²¨æ—¥æ¯é€±ä¸‰èˆ‡é€±å…­
</div>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <button id="openWishBtn">ğŸŒ  è¨±é¡˜æ¸…å–®</button>
  <button id="openCartBtn">ğŸ›’ è³¼ç‰©è»Š <span id="cartCount" class="cart-count" style="display:none">0</span></button>
  <button id="openRecordsBtn">ğŸ§¾ è³¼ç‰©è»Šç´€éŒ„</button>
</div>

<!-- ================= CONTROLS ================= -->
<div class="controls container">
  <div class="multi-select" id="categoryMulti">
    <div class="label" id="categoryLabel">åˆ†é¡ç¯©é¸ Â· å¤šé¸ <span id="selectedCount" style="margin-left:auto;color:var(--muted);font-weight:600">å…¨éƒ¨</span></div>
    <div class="panel" id="categoryPanel"></div>
  </div>
  <input type="text" id="searchBox" placeholder="æœå°‹å•†å“åç¨±..." style="padding:8px;border-radius:8px;border:1px solid #ddd;width:320px">
</div>

<!-- ================= PRODUCT AREA ================= -->
<div class="container">
  <div class="table-header">
    <div>åœ–ç‰‡</div>
    <div>åç¨±</div>
    <div>å“ç‰Œ</div>
    <div>åƒ¹æ ¼</div>
    <div>æ•¸é‡</div>
    <div style="text-align:center">æ“ä½œ</div>
  </div>
  <div id="productArea"></div>
</div>

<!-- ================= CART PANEL ================= -->
<div class="panel" id="cartPanel" aria-hidden="true">
  <h3>è³¼ç‰©è»Š</h3>
  <div id="cartItemsContainer"></div>
  <div style="margin-top:8px">
    <label>å§“å</label>
    <input id="checkoutName" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px">
    <label>é›»è©±</label>
    <input id="checkoutPhone" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px">
    <label>Email</label>
    <input id="checkoutEmail" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px">
  </div>
  <div class="cart-actions">
    <button class="btn btn-ghost" id="closeCart">é—œé–‰</button>
    <button class="btn btn-primary" id="submitOrderBtn">é€å‡ºè¨‚å–®</button>
  </div>
</div>

<!-- ================= RECORDS PANEL ================= -->
<div class="panel" id="recordsPanel" aria-hidden="true" style="display:none;right:auto;left:50%;transform:translateX(20%);width:520px">
  <h3>è³¼ç‰©è»Šç´€éŒ„</h3>
  <div style="display:flex;gap:8px;margin-bottom:8px">
    <input id="recordsEmail" placeholder="è¼¸å…¥ Email æŸ¥è©¢" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd">
    <button class="btn btn-primary" id="lookupRecords">æŸ¥è©¢</button>
  </div>
  <div class="records-list" id="recordsList"></div>
  <div style="display:flex;justify-content:flex-end;margin-top:8px">
    <button class="btn btn-ghost" id="closeRecords">é—œé–‰</button>
  </div>
</div>

<!-- ================= OVERLAY ================= -->
<div class="overlay" id="overlay"></div>

<!-- ================= WISHLIST POPUP ================= -->
<div class="wish-popup" id="wishPopup">
  <h4>è¨±é¡˜æ¸…å–® âœ¨</h4>
  <input id="wishImg" placeholder="åœ–ç‰‡é€£çµ (https://...)">
  <input id="wishProduct" placeholder="ç”¢å“åç¨±">
  <input id="wishPerson" placeholder="è¨±é¡˜äººå§“å">
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn-ghost" id="closeWish">é—œé–‰</button>
    <button class="btn-primary" id="submitWishBtn">æäº¤</button>
  </div>
</div>

<!-- ================= IMAGE PREVIEW ================= -->
<div class="img-preview" id="imgPreview" onclick="hideImagePreview()"><img src="" alt="preview"></div>

<!-- ===================== SCRIPT ===================== -->
<script>
/* ===================== GAS API URL ======================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzue0Tf2llwjtmzaxN1peGdZ5i3mPKEQ_iD9W-zu6VXwfk1M_7flUGn5smFvUYtlbp8/exec"; // æ›¿æ›æˆä½ çš„éƒ¨ç½²ID

/* ===================== DATA & STORAGE ======================= */
let PRODUCTS = []; // å°‡å¾ GAS è®€å–å•†å“
const STORAGE_KEYS = { CART:'tg_cart_v1', WISHLIST:'tg_wishlist_v1', ORDERS:'tg_orders_v1' };
function readStorage(key,fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){return fallback;} }
function writeStorage(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ===================== STATE ======================= */
let cart = readStorage(STORAGE_KEYS.CART, []); // [{code, qty}]
let wishlist = readStorage(STORAGE_KEYS.WISHLIST, []);

/* ===================== LOAD PRODUCTS FROM GAS ======================= */
async function loadProducts(){
  try{
    const res = await fetch(GAS_URL+'?action=getProducts');
    const data = await res.json();
    PRODUCTS = data;
    buildCategoryPanel(); updateCategoryLabel(); renderProducts();
  }catch(err){ console.error('è®€å–å•†å“å¤±æ•—', err); }
}
loadProducts();

/* ===================== CATEGORY PANEL ===================== */
let selectedCategories = new Set();
const categoryPanel = document.getElementById('categoryPanel');
const selectedCountSpan = document.getElementById('selectedCount');

function uniqueCategories(){ return [...new Set(PRODUCTS.map(p=>p.category))]; }

function buildCategoryPanel(){
  categoryPanel.innerHTML='';
  uniqueCategories().forEach(cat=>{
    const id='chk_'+cat;
    const label=document.createElement('label');
    label.innerHTML=`<input type="checkbox" value="${cat}" id="${id}" ${selectedCategories.has(cat)?'checked':''}> <span>${cat}</span>`;
    categoryPanel.appendChild(label);
    label.querySelector('input').addEventListener('change',(e)=>{
      if(e.target.checked) selectedCategories.add(cat); else selectedCategories.delete(cat);
      updateCategoryLabel(); renderProducts();
    });
  });
  const hr=document.createElement('div'); hr.style.margin='6px 0';
  categoryPanel.appendChild(hr);
  const btnAll=document.createElement('button'); btnAll.textContent='å…¨éƒ¨'; btnAll.style.marginRight='8px';
  btnAll.onclick=()=>{ selectedCategories.clear(); updateCategoryLabel(); renderProducts(); hideCategoryPanel(); };
  const btnClear=document.createElement('button'); btnClear.textContent='æ¸…é™¤';
  btnClear.onclick=()=>{ selectedCategories.clear(); updateCategoryLabel(); renderProducts(); };
  categoryPanel.appendChild(btnAll); categoryPanel.appendChild(btnClear);
}
function updateCategoryLabel(){ selectedCountSpan.textContent = selectedCategories.size===0?'å…¨éƒ¨':Array.from(selectedCategories).join('ã€'); }
document.querySelector('.multi-select .label').addEventListener('click',()=>{ categoryPanel.style.display=(categoryPanel.style.display==='block'?'none':'block'); });
document.addEventListener('click',(e)=>{ if(!document.getElementById('categoryMulti').contains(e.target)) categoryPanel.style.display='none'; });
function hideCategoryPanel(){ categoryPanel.style.display='none'; }

/* ===================== SEARCH ===================== */
let searchQuery = '';
document.getElementById('searchBox').addEventListener('input',(e)=>{ searchQuery=e.target.value.trim().toLowerCase(); renderProducts(); });

/* ===================== PRODUCT RENDER ===================== */
const productArea = document.getElementById('productArea');
function renderProducts(){
  productArea.innerHTML='';
  uniqueCategories().forEach(cat=>{
    if(selectedCategories.size>0 && !selectedCategories.has(cat)) return;
    const block=document.createElement('div'); block.className='category-block';
    const title=document.createElement('div'); title.className='category-title';
    title.innerHTML=`<h3>${cat}</h3><span>${PRODUCTS.filter(p=>p.category===cat).length}</span>`;
    block.appendChild(title);
    PRODUCTS.filter(p=>p.category===cat && (p.name.toLowerCase().includes(searchQuery) || !searchQuery)).forEach(p=>{
      const row=document.createElement('div'); row.className='product';
      row.innerHTML=`
        <div><img src="${p.img}" alt="${p.name}" loading="lazy" onclick="showImage('${p.img}')"></div>
        <div class="meta">${p.name}</div>
        <div class="muted">${p.brand}</div>
        <div class="meta">$${p.price}</div>
        <div><input type="number" min="1" value="1" id="qty_${p.code}" class="qty-input"></div>
        <div style="text-align:center"><button class="btn-add" data-code="${p.code}">åŠ å…¥è³¼ç‰©è»Š</button></div>
      `;
      block.appendChild(row);
    });
    productArea.appendChild(block);
  });

  document.querySelectorAll('.btn-add').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const code=e.currentTarget.dataset.code;
      const qty=parseInt(document.getElementById('qty_'+code).value)||1;
      addToCart(code,qty); showCartPanel();
    });
  });
}

/* ===================== CART ===================== */
const cartCountElem = document.getElementById('cartCount');
const cartPanel = document.getElementById('cartPanel');
function addToCart(code,qty=1){
  const idx=cart.findIndex(c=>c.code===code);
  if(idx>=0) cart[idx].qty+=qty; else cart.push({code,qty});
  writeStorage(STORAGE_KEYS.CART,cart);
  renderCartItems(); updateCartCount();
}
function renderCartItems(){
  const container=document.getElementById('cartItemsContainer');
  container.innerHTML='';
  if(cart.length===0){ container.innerHTML='<div style="color:var(--muted);padding:6px">è³¼ç‰©è»Šç©ºç©ºå¦‚ä¹Ÿ</div>'; return; }
  cart.forEach((ci,i)=>{
    const p = PRODUCTS.find(x=>x.code===ci.code);
    const div=document.createElement('div'); div.className='cart-item';
    div.innerHTML=`
      <div>${p.name} x ${ci.qty}</div>
      <div>$${p.price*ci.qty}</div>
      <div><button data-i="${i}">åˆªé™¤</button></div>
    `;
    div.querySelector('button').addEventListener('click',()=>{ cart.splice(i,1); writeStorage(STORAGE_KEYS.CART,cart); renderCartItems(); updateCartCount(); });
    container.appendChild(div);
  });
}
function updateCartCount(){ cartCountElem.textContent=cart.reduce((a,c)=>a+c.qty,0); }
function showCartPanel(){ cartPanel.style.display='block'; }
function closeCartPanel(){ cartPanel.style.display='none'; }

/* ===================== SUBMIT ORDER ===================== */
async function submitOrder(){
  const name = document.getElementById('checkoutName').value.trim();
  const phone = document.getElementById('checkoutPhone').value.trim();
  const email = document.getElementById('checkoutEmail').value.trim();
  if(!name || !phone || !email){ alert('è«‹å®Œæ•´å¡«å¯«è³‡æ–™'); return; }
  if(cart.length===0){ alert('è³¼ç‰©è»Šæ²’æœ‰å•†å“'); return; }

  const order = {name,phone,email,cart:cart.map(ci=>{
    const p=PRODUCTS.find(x=>x.code===ci.code); return {code:p.code,name:p.name,brand:p.brand,price:p.price,qty:ci.qty,img:p.img};
  })};

  try{
    const res = await fetch(GAS_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'submitOrder',order}) });
    const data = await res.json();
    if(data.status==='ok'){
      alert('è¨‚å–®å·²é€å‡º âœ…'); cart=[]; writeStorage(STORAGE_KEYS.CART,cart); renderCartItems(); updateCartCount();
      document.getElementById('checkoutName').value=''; document.getElementById('checkoutPhone').value=''; document.getElementById('checkoutEmail').value='';
      closeCartPanel();
    }else alert('é€å‡ºå¤±æ•—');
  }catch(err){ console.error(err); alert('é€å‡ºå¤±æ•—'); }
}

/* ===================== WISHLIST ===================== */
const wishPopup = document.getElementById('wishPopup');
document.getElementById('submitWishBtn').addEventListener('click', async ()=>{
  const img = document.getElementById('wishImg').value.trim();
  const name = document.getElementById('wishProduct').value.trim();
  const person = document.getElementById('wishPerson').value.trim();
  if(!name || !person){ alert('è«‹å¡«å¯«ç”¢å“åç¨±èˆ‡è¨±é¡˜äºº'); return; }

  const wish = {img,name,person};
  try{
    const res = await fetch(GAS_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'addWish',wish}) });
    const data = await res.json();
    if(data.status==='ok'){ alert('å·²åŠ å…¥è¨±é¡˜æ¸…å–® âœ…'); wishPopup.style.display='none'; document.getElementById('overlay').style.display='none'; }
    else alert('é€å‡ºå¤±æ•—');
  }catch(err){ console.error(err); alert('é€å‡ºå¤±æ•—'); }
});

/* ===================== IMAGE PREVIEW ===================== */
function showImage(src){ const imgPop=document.getElementById('imgPreview'); imgPop.querySelector('img').src=src; imgPop.style.display='block'; }
function closeImgPreview(){ document.getElementById('imgPreview').style.display='none'; }
</script>

</body>
</html>
