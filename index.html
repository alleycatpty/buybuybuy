<!-- å°å‹åœ˜è³¼ç¶²ç«™ - å®Œæ•´ç‰ˆæ¶æ§‹ï¼ˆå«è¨»è§£èˆ‡åŠŸèƒ½å€å¡Šåˆ†å±¤ï¼‰ -->
<!-- æç¤ºï¼šæœ¬æª”æ¡ˆåŒ…å« HTML çµæ§‹ã€UIã€ç©ºçš„åŠŸèƒ½æ›è¼‰é»ã€è¨»è§£ç­‰ã€‚
     JS æœƒåœ¨ä¸‹æ–¹ script å€å¡Šé›†ä¸­ç®¡ç†ï¼Œä¸¦åˆ†æˆå¤šå€‹åŠŸèƒ½æ¨¡çµ„ã€‚ -->

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°å‹åœ˜è³¼ç¶²ç«™</title>
  <style>
    /* ======== [å…¨åŸŸè¨­å®š] ======== */
    :root {
        --primary: #ff8a5b;
        --accent: #ffd7a3;
        --bg: #fff9f3;
        --muted: #666;
        --card: #fff;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: "Segoe UI","Noto Sans TC",Arial;
      background:var(--bg);
      color:#222;
    }

    /* ======== HEADER ======== */
    header{
      background:var(--primary);
      color:#fff;
      padding:14px;
      font-weight:700;
      text-align:center;
      position:sticky;top:0;z-index:120;
    }
    .rules{
      background:var(--accent);
      padding:6px;
      font-size:14px;
      text-align:center;
    }

    /* ======== TOP BAR ======== */
    .topbar{
      display:flex;gap:10px;justify-content:center;
      padding:10px;background:var(--accent);
      position:sticky;top:72px;z-index:115;
    }
    .topbar button{
      background:#fff;border:2px solid var(--primary);color:var(--primary);
      padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;
      position:relative;
    }
    .topbar button:hover{ background:var(--primary); color:#fff; }
    .cart-count{
      position:absolute;top:-6px;right:-6px;background:red;color:#fff;
      font-size:12px;width:18px;height:18px;border-radius:50%;display:flex;
      align-items:center;justify-content:center;font-weight:700;
    }

    /* ======== CONTROLS ======== */
    .controls{
      display:flex;gap:12px;justify-content:center;align-items:center;
      padding:12px;position:sticky;top:106px;z-index:110;
    }
    .multi-select{ position:relative;width:260px; }
    .multi-select .label{
      display:flex;align-items:center;gap:8px;background:#fff;
      border-radius:8px;padding:8px;border:1px solid #ddd;cursor:pointer;
    }
    .multi-select .panel{
      position:absolute;top:calc(100% + 6px);left:0;right:0;background:#fff;
      border:1px solid #ddd;border-radius:8px;padding:8px;max-height:220px;
      display:none;overflow:auto;z-index:130;box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }

    /* ======== PRODUCT LIST ======== */
    .container{ max-width:1100px;margin:18px auto;padding:0 12px; }
    .table-header{
      display:grid;grid-template-columns:100px 1fr 1fr 90px 110px 120px;
      padding:10px 12px;gap:8px;font-weight:700;color:var(--muted);
      background:linear-gradient(90deg,#fff7f0,#fff3e8);
      border-radius:8px;position:sticky;top:158px;z-index:100;
      box-shadow:0 3px 6px rgba(0,0,0,0.03);
    }
    .category-block{ background:var(--card);padding:10px;border-radius:10px;
      border:1px solid #f2e6db;margin-top:18px; }
    .product{
      display:grid;grid-template-columns:100px 1fr 1fr 90px 110px 120px;
      padding:8px;gap:8px;align-items:center;
    }
    .product + .product { border-top:1px dashed #f0e6db }
    .product img{
      width:76px;height:76px;object-fit:cover;border-radius:8px;border:1px solid #eee;
      cursor:pointer;margin:auto;
    }
    .no-img{
      width:76px;height:76px;border-radius:8px;border:1px solid #eee;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;color:var(--muted);background:#faf5ef;margin:auto;
    }
    .img-preview{
      position:fixed;left:0;top:0;right:0;bottom:0;
      background:rgba(0,0,0,0.8);
      display:none;align-items:center;justify-content:center;
      z-index:300;
    }
    .img-preview img{
      max-width:92%;max-height:92%;border-radius:10px;background:#fff;
    }
.btn-add{
      background:var(--primary);color:#fff;border:none;padding:8px 12px;
      border-radius:8px;font-weight:700;cursor:pointer;
    }
    .btn-ghost{
      background:#fff;border:1px solid #ccc;color:var(--muted);
      padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;
    }
    .btn-ghost:hover{ background:#f5f5f5; }
    .input-full{
      width:100%;padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ddd;
      font-size:14px;
    }
    .qty-input{
      width:72px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center;
    }
/* ======== PANELS ======== */
    .panel{ display:none;position:fixed;right:18px;top:100px;width:420px;
      max-height:78vh;overflow:auto;background:#fff;padding:12px;
      border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:220; }
    .panel.open{ display:block }

    .overlay{ position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.36);
      display:none;z-index:210; }
    .overlay.show{ display:block }
  </style>
</head>
<body>

  <!-- HEADER & RULES -->
  <header>å°å‹åœ˜è³¼ç¶²ç«™</header>
  <div class="rules" id="rules">è¼‰å…¥ä¸­...</div>

  <!-- TOPBAR -->
  <div class="topbar">
    <button id="openWishBtn">ğŸŒ  è¨±é¡˜æ¸…å–®</button>
    <button id="openCartBtn">ğŸ›’ è³¼ç‰©è»Š <span id="cartCount" class="cart-count" style="display:none">0</span></button>
    <button id="openRecordsBtn">ğŸ§¾ è³¼ç‰©ç´€éŒ„</button>
  </div>

  <!-- CONTROLS -->
  <div class="controls container">
    <div class="multi-select" id="categoryMulti">
      <div class="label" id="categoryLabel">åˆ†é¡ç¯©é¸ Â· å¤šé¸ <span id="selectedCount" style="margin-left:auto;color:var(--muted);font-weight:600">å…¨éƒ¨</span></div>
      <div class="panel" id="categoryPanel"></div>
    </div>
    <input id="searchBox" type="text" placeholder="æœå°‹å•†å“åç¨±..." style="padding:8px;border-radius:8px;border:1px solid #ddd;width:320px">
  </div>

  <!-- PRODUCT LIST -->
  <div class="container">
    <div class="table-header">
      <div>åœ–ç‰‡</div><div>åç¨±</div><div>å“ç‰Œ</div><div>åƒ¹æ ¼</div><div>æ•¸é‡</div><div>æ“ä½œ</div>
    </div>
    <div id="productArea"></div>
  </div>

  <!-- è³¼ç‰©è»Š PANEL -->
  <div class="panel" id="cartPanel">
    <form id="orderForm" target="hidden_iframe">
      <h3>è³¼ç‰©è»Š</h3>
      <div id="cartItemsContainer"></div>

      <input type="hidden" name="action" value="submitOrder">
      <input type="hidden" name="cart" id="cartInput">

      <input name="checkoutName" id="checkoutName" placeholder="å§“å" class="input-full">
      <input name="checkoutPhone" id="checkoutPhone" placeholder="é›»è©±" class="input-full">
      <input name="checkoutEmail" id="checkoutEmail" placeholder="Email" class="input-full">

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button type="button" id="closeCart">é—œé–‰</button>
        <button type="submit" class="btn-add">é€å‡ºè¨‚å–®</button>
      </div>
    </form>
  </div>

  <!-- è¨±é¡˜æ¸…å–® PANEL -->
  <div class="panel" id="wishPanel">
    <h3>è¨±é¡˜æ¸…å–® âœ¨</h3>
    <div>
      <input id="wishImg" class="input-full" placeholder="åœ–ç‰‡é€£çµ (é¸å¡«)">
      <input id="wishName" class="input-full" placeholder="ç”¢å“åç¨±">
      <input id="wishPerson" class="input-full" placeholder="è¨±é¡˜äººå§“å">
      <div style="display:flex;justify-content:flex-end;margin-top:4px;gap:8px;">
        <button type="button" class="btn-ghost" id="closeWish">é—œé–‰</button>
        <button type="button" class="btn-add" id="submitWishBtn">é€å‡ºè¨±é¡˜</button>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #f0e0d2;">
    <div id="wishList" style="font-size:14px;color:var(--muted);"></div>
  </div>

  <!-- è³¼è²·ç´€éŒ„ PANEL -->
  <div class="panel" id="recordsPanel">
    <h3>è³¼ç‰©ç´€éŒ„</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <input id="recordsEmail" class="input-full" placeholder="è¼¸å…¥ Email æŸ¥è©¢">
      <button type="button" class="btn-add" id="lookupRecordsBtn" style="white-space:nowrap;">æŸ¥è©¢</button>
    </div>
    <div id="recordsList" style="max-height:400px;overflow:auto;font-size:14px;"></div>
  </div>

  <!-- èƒŒæ™¯é®ç½© -->
  <div class="overlay" id="overlay"></div>

  <!-- IFRAMEï¼ˆé¿å… CORSï¼Œç”¨ä¾†æ¥ GAS å›å‚³è¨Šè™Ÿï¼‰ -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

  <!-- è¨±é¡˜ç”¨éš±è—è¡¨å–®ï¼ˆPOST é€åˆ° GASï¼Œé¿é–‹ CORSï¼‰ -->
  <form id="wishForm" target="hidden_iframe" style="display:none;">
    <input type="hidden" name="action" value="addWish">
    <input type="hidden" name="name" id="wishNameField">
    <input type="hidden" name="img" id="wishImgField">
    <input type="hidden" name="person" id="wishPersonField">
  </form>

  <!-- åœ–ç‰‡æ”¾å¤§é è¦½ -->
  <div class="img-preview" id="imgPreview">
    <img src="" alt="é è¦½åœ–ç‰‡">
  </div>


  <!-- =============================
       SCRIPT å€å¡Šï¼ˆJS æ¨¡çµ„åˆ†å±¤ï¼‰
       ============================= -->
  <script>
  /* =====================================================
     CONFIG & GLOBAL STATE (GitHub / éœæ…‹ç¶²ç«™ç‰ˆ)
     - è®€è³‡æ–™ï¼šç”¨ fetch(GAS_URL?action=...)
     - å¯«è³‡æ–™ï¼šç”¨ form POST + hidden iframeï¼Œå®Œå…¨é¿é–‹ CORS
  ===================================================== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbx4x3QOGcG0h1mHZQGAlKkKfGVEQRP-FiS-sG1uN0D07O9Wj8xOzcstXTbthqE9qslI/exec";

  let PRODUCTS = [];
  let FILTERED_PRODUCTS = [];
  let CART = [];
  let WISHES = [];
  let selectedCategories = new Set();
  let searchKeyword = "";

  document.addEventListener("DOMContentLoaded", () => {
    console.log("[INIT] Groupbuy GitHub + GAS WebApp (fetch + form POST)");
    bindBaseEvents();
    loadRules();
    loadProducts();
    restoreFromStorage();

    const preview = document.getElementById("imgPreview");
    if (preview) {
      preview.addEventListener("click", () => {
        preview.style.display = "none";
      });
    }
  });

  /* ================== LOAD RULES / PRODUCTS ================== */
  async function loadRules() {
    try {
      const res = await fetch(`${GAS_URL}?action=getRules`);
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      const data = await res.json();
      document.getElementById("rules").textContent = data.rules || "";
    } catch (err) {
      console.error("[RULES] è¼‰å…¥å¤±æ•—", err);
      document.getElementById("rules").textContent = "è®€å–è¦å‰‡å¤±æ•—";
    }
  }

  async function loadProducts() {
    const area = document.getElementById("productArea");
    try {
      console.log("[PRODUCTS] è®€å–ä¸­...", GAS_URL);
      const res = await fetch(`${GAS_URL}?action=getProducts`);
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      const data = await res.json();
      PRODUCTS = Array.isArray(data) ? data : (data.products || []);
      FILTERED_PRODUCTS = PRODUCTS.slice();
      console.log("[PRODUCTS] ç­†æ•¸:", PRODUCTS.length);

      if (!PRODUCTS.length) {
        area.innerHTML = "<p style='padding:12px;'>ç›®å‰æ²’æœ‰å•†å“è³‡æ–™ã€‚</p>";
        return;
      }
      buildCategoryFilter();
      renderProducts();
    } catch (err) {
      console.error("[PRODUCTS] è¼‰å…¥å¤±æ•—", err);
      area.innerHTML = "<p style='padding:12px;color:#c00;'>å•†å“è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>";
    }
  }

  /* ================== EVENT BINDING ================== */
  function bindBaseEvents() {
    const overlay = document.getElementById("overlay");

    document.getElementById("openCartBtn").onclick = () => {
      renderCart();
      openPanel("cartPanel");
    };
    document.getElementById("closeCart").onclick = () => closePanel("cartPanel");

    document.getElementById("openWishBtn").onclick = () => openPanel("wishPanel");
    document.getElementById("closeWish").onclick = () => closePanel("wishPanel");

    document.getElementById("openRecordsBtn").onclick = () => openPanel("recordsPanel");

    overlay.onclick = closeAllPanels;

    document.getElementById("searchBox").addEventListener("input", e => {
      searchKeyword = e.target.value.trim();
      applyFilters();
    });

    document.getElementById("categoryLabel").addEventListener("click", () => {
      const panel = document.getElementById("categoryPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    });

    document.getElementById("productArea").addEventListener("click", e => {
      if (e.target.matches("button[data-add]")) {
        const code = e.target.dataset.add;
        handleAddToCart(code);
        return;
      }
      if (e.target.matches(".product img")) {
        showImagePreview(e.target.src);
        return;
      }
    });

    document.getElementById("orderForm").addEventListener("submit", e => {
      e.preventDefault();
      submitOrder();
    });

    document.getElementById("submitWishBtn").onclick = submitWish;
    document.getElementById("lookupRecordsBtn").onclick = lookupRecords;
  }

  /* ================== PANEL CONTROL ================== */
  function openPanel(id) {
    document.getElementById(id).classList.add("open");
    document.getElementById("overlay").classList.add("show");
  }
  function closePanel(id) {
    document.getElementById(id).classList.remove("open");
    if (!document.querySelector(".panel.open")) {
      document.getElementById("overlay").classList.remove("show");
    }
  }
  function closeAllPanels() {
    document.querySelectorAll(".panel.open").forEach(p => p.classList.remove("open"));
    document.getElementById("overlay").classList.remove("show");
  }

  /* ================== FILTER & PRODUCTS ================== */
  function buildCategoryFilter() {
    const panel = document.getElementById("categoryPanel");
    const cats = [...new Set(PRODUCTS.map(p => p.category).filter(Boolean))].sort();
    if (!cats.length) {
      panel.innerHTML = "<div style='font-size:13px;color:var(--muted)'>ç›®å‰æ²’æœ‰åˆ†é¡</div>";
      return;
    }
    panel.innerHTML = cats.map(cat => `
      <label style="display:flex;align-items:center;gap:6px;padding:4px 2px;font-size:14px;">
        <input type="checkbox" value="${cat}"> ${cat}
      </label>
    `).join("");

    panel.addEventListener("change", e => {
      if (e.target.matches("input[type='checkbox']")) {
        const val = e.target.value;
        if (e.target.checked) selectedCategories.add(val);
        else selectedCategories.delete(val);
        updateSelectedCategoryLabel();
        applyFilters();
      }
    });
  }

  function updateSelectedCategoryLabel() {
    const labelSpan = document.getElementById("selectedCount");
    if (!selectedCategories.size) labelSpan.textContent = "å…¨éƒ¨";
    else labelSpan.textContent = `å·²é¸ ${selectedCategories.size}`;
  }

  function applyFilters() {
    FILTERED_PRODUCTS = PRODUCTS.filter(p => {
      if (selectedCategories.size && !selectedCategories.has(p.category)) return false;
      if (searchKeyword) {
        const kw = searchKeyword.toLowerCase();
        const name = (p.name || "").toLowerCase();
        const brand = (p.brand || "").toLowerCase();
        if (!name.includes(kw) && !brand.includes(kw)) return false;
      }
      return true;
    });
    renderProducts();
  }

  function renderProducts() {
    const area = document.getElementById("productArea");
    area.innerHTML = "";
    if (!FILTERED_PRODUCTS.length) {
      area.innerHTML = "<p style='padding:12px;'>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“ã€‚</p>";
      return;
    }

    const byCat = {};
    FILTERED_PRODUCTS.forEach(p => {
      const c = p.category || "æœªåˆ†é¡";
      if (!byCat[c]) byCat[c] = [];
      byCat[c].push(p);
    });

    Object.keys(byCat).sort().forEach(cat => {
      const block = document.createElement("div");
      block.className = "category-block";

      const title = document.createElement("h4");
      title.textContent = cat;
      title.style.margin = "4px 0 8px";
      block.appendChild(title);

      byCat[cat].forEach(p => {
        const row = document.createElement("div");
        row.className = "product";
        const imgCell = p.img
          ? `<img src="${p.img}" alt="${p.name || "å•†å“"}">`
          : `<div class="no-img">ç„¡åœ–ç‰‡</div>`;
        row.innerHTML = `
          <div>${imgCell}</div>
          <div>${p.name || "æœªå‘½åå•†å“"}</div>
          <div>${p.brand || "-"}</div>
          <div>$${formatMoney(p.price || 0)}</div>
          <div><input type="number" min="1" value="1" class="qty-input" data-code="${p.code}"></div>
          <div style="text-align:center;"><button class="btn-add" data-add="${p.code}">åŠ å…¥</button></div>
        `;
        block.appendChild(row);
      });

      area.appendChild(block);
    });
  }

  /* ================== CART ================== */
  function handleAddToCart(code) {
    const product = PRODUCTS.find(p => p.code === code);
    if (!product) return;
    const qtyInput = document.querySelector(`input.qty-input[data-code="${code}"]`);
    const qty = parseInt(qtyInput && qtyInput.value, 10) || 1;

    let item = CART.find(i => i.code === code);
    if (item) item.qty += qty;
    else {
      item = {
        code: product.code,
        name: product.name,
        brand: product.brand,
        price: Number(product.price) || 0,
        img: product.img,
        category: product.category,
        qty
      };
      CART.push(item);
    }
    console.log("[CART] åŠ å…¥", item);
    updateCartCount();
    saveToStorage();
  }

  function formatMoney(value) {
    const n = Number(value) || 0;
    return n.toFixed(2);
  }

  function renderCart() {
    const box = document.getElementById("cartItemsContainer");
    if (!box) return;

    if (!CART.length) {
      box.innerHTML = "<p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>";
      updateCartCount();
      return;
    }

    let total = 0;
    box.innerHTML = CART.map(item => {
      const sub = item.price * item.qty;
      total += sub;
      const imgCell = item.img
        ? `<img src="${item.img}" class="cart-img" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">`
        : `<div class="no-img" style="width:50px;height:50px;font-size:11px;">ç„¡åœ–ç‰‡</div>`;
      return `
        <div class="cart-item" data-code="${item.code}" style="display:flex;gap:8px;margin-bottom:8px;background:#fff8f3;border-radius:8px;padding:6px;">
          ${imgCell}
          <div style="flex:1;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="font-weight:600;">${item.name}</span>
              <button type="button" class="btn-ghost btn-remove" style="border:none;color:red;background:none;">åˆªé™¤</button>
            </div>
            <div style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-top:2px;">
              <span>æ•¸é‡</span>
              <input type="number" min="1" value="${item.qty}" class="cart-qty" style="width:60px;">
              <span>å°è¨ˆ $${formatMoney(sub)}</span>
            </div>
          </div>
        </div>
      `;
    }).join("") + `
      <div style="text-align:right;font-weight:700;margin-top:4px;">ç¸½è¨ˆï¼š$${formatMoney(total)}</div>
    `;

    box.querySelectorAll(".btn-remove").forEach(btn => {
      btn.onclick = () => {
        const code = btn.closest(".cart-item").dataset.code;
        CART = CART.filter(i => i.code !== code);
        renderCart();
        updateCartCount();
        saveToStorage();
      };
    });

    box.querySelectorAll(".cart-qty").forEach(input => {
      input.onchange = () => {
        const code = input.closest(".cart-item").dataset.code;
        const item = CART.find(i => i.code === code);
        if (!item) return;
        const v = parseInt(input.value, 10) || 1;
        item.qty = v;
        renderCart();
        updateCartCount();
        saveToStorage();
      };
    });

    box.querySelectorAll(".cart-img").forEach(img => {
      img.onclick = () => showImagePreview(img.src);
    });
  }

  function updateCartCount() {
    const count = CART.reduce((s, i) => s + i.qty, 0);
    const el = document.getElementById("cartCount");
    if (count > 0) {
      el.style.display = "flex";
      el.textContent = count;
    } else {
      el.style.display = "none";
    }
  }

  function saveToStorage() {
    try {
      localStorage.setItem("groupbuy_cart", JSON.stringify(CART));
    } catch (e) {
      console.warn("localStorage å¯«å…¥å¤±æ•—", e);
    }
  }

  function restoreFromStorage() {
    try {
      const raw = localStorage.getItem("groupbuy_cart");
      if (raw) {
        CART = JSON.parse(raw) || [];
        updateCartCount();
      }
    } catch (e) {
      console.warn("localStorage è®€å–å¤±æ•—", e);
    }
  }

  /* ================== ORDER SUBMIT (form + iframe) ================== */
  function submitOrder() {
    if (!CART.length) {
      alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
      return;
    }
    const name = document.getElementById("checkoutName").value.trim();
    const phone = document.getElementById("checkoutPhone").value.trim();
    const email = document.getElementById("checkoutEmail").value.trim();
    if (!name || !phone || !email) {
      alert("è«‹å®Œæ•´å¡«å¯«å§“åã€é›»è©±èˆ‡ Email");
      return;
    }

    const form = document.getElementById("orderForm");
    document.getElementById("cartInput").value = JSON.stringify(CART);

    form.action = GAS_URL;
    form.method = "POST";
    form.submit();

    alert("è¨‚å–®å·²é€å‡ºï¼Œæ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼");
    CART = [];
    saveToStorage();
    renderCart();
    updateCartCount();
    closePanel("cartPanel");
  }

  /* ================== WISH (form + iframe) ================== */
  function submitWish() {
    const img = document.getElementById("wishImg").value.trim();
    const name = document.getElementById("wishName").value.trim();
    const person = document.getElementById("wishPerson").value.trim();
    if (!name || !person) {
      alert("è«‹å¡«å¯«ç”¢å“åç¨±èˆ‡è¨±é¡˜äººå§“å");
      return;
    }

    document.getElementById("wishNameField").value = name;
    document.getElementById("wishImgField").value = img;
    document.getElementById("wishPersonField").value = person;

    const form = document.getElementById("wishForm");
    form.action = GAS_URL;
    form.method = "POST";
    form.submit();

    alert("è¨±é¡˜å·²é€å‡º ğŸ™Œ");
    WISHES.push({ img, name, person });
    renderWishes();

    document.getElementById("wishImg").value = "";
    document.getElementById("wishName").value = "";
    document.getElementById("wishPerson").value = "";
  }

  function renderWishes() {
    const box = document.getElementById("wishList");
    if (!WISHES.length) {
      box.innerHTML = "<p>ç›®å‰æ²’æœ‰è¨±é¡˜ç´€éŒ„ï¼ˆæœ¬å€åªé¡¯ç¤ºæœ¬æ¬¡ç€è¦½æœŸé–“é€å‡ºçš„è¨±é¡˜ï¼‰ã€‚</p>";
      return;
    }
    box.innerHTML = WISHES.map(w => `
      <div style="margin-bottom:6px;">
        <div><b>${w.name}</b></div>
        <div style="font-size:13px;color:var(--muted);">${w.person}</div>
      </div>
    `).join("");
  }

  /* ================== IMAGE PREVIEW ================== */
  function showImagePreview(src) {
    const box = document.getElementById("imgPreview");
    if (!box) return;
    box.querySelector("img").src = src;
    box.style.display = "flex";
  }

  /* ================== RECORDS (fetch JSON) ================== */
  async function lookupRecords() {
    const email = document.getElementById("recordsEmail").value.trim();
    if (!email) {
      alert("è«‹å…ˆè¼¸å…¥ Email");
      return;
    }
    try {
      const res = await fetch(`${GAS_URL}?action=getRecords&email=${encodeURIComponent(email)}`);
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      const data = await res.json();
      const records = data.records || data || [];
      renderRecords(records);
    } catch (err) {
      console.error("[RECORDS] æŸ¥è©¢å¤±æ•—", err);
      alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  function renderRecords(list) {
    const box = document.getElementById("recordsList");
    if (!list.length) {
      box.innerHTML = "<p>æŸ¥ç„¡ç´€éŒ„</p>";
      return;
    }
    box.innerHTML = list.map(r => `
      <div style="background:#fff8f3;border-radius:8px;padding:6px;margin-bottom:6px;border:1px solid #f2e6db;">
        <div><b>${r.date || ""}</b></div>
        <div style="font-size:13px;color:var(--muted);">${r.items || ""}</div>
      </div>
    `).join("");
  }
  </script>
</body>
</html>
