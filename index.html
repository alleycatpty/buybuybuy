<!-- å°å‹åœ˜è³¼ç¶²ç«™ - å®Œæ•´ç‰ˆæ¶æ§‹ï¼ˆå«è¨»è§£èˆ‡åŠŸèƒ½å€å¡Šåˆ†å±¤ï¼‰ -->
<!-- æç¤ºï¼šæœ¬æª”æ¡ˆåŒ…å« HTML çµæ§‹ã€UIã€ç©ºçš„åŠŸèƒ½æ›è¼‰é»ã€è¨»è§£ç­‰ã€‚
     JS æœƒåœ¨ä¸‹æ–¹ script å€å¡Šé›†ä¸­ç®¡ç†ï¼Œä¸¦åˆ†æˆå¤šå€‹åŠŸèƒ½æ¨¡çµ„ã€‚ -->

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°å‹åœ˜è³¼ç¶²ç«™</title>
  <style>
    /* ======== [å…¨åŸŸè¨­å®š] ======== */
    :root {
        --primary: #ff8a5b;
        --accent: #ffd7a3;
        --bg: #fff9f3;
        --muted: #666;
        --card: #fff;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: "Segoe UI","Noto Sans TC",Arial;
      background:var(--bg);
      color:#222;
    }

    /* ======== HEADER ======== */
    header{
      background:var(--primary);
      color:#fff;
      padding:14px;
      font-weight:700;
      text-align:center;
      position:sticky;top:0;z-index:120;
    }
    .rules{
      background:var(--accent);
      padding:6px;
      font-size:14px;
      text-align:center;
    }

    /* ======== TOP BAR ======== */
    .topbar{
      display:flex;gap:10px;justify-content:center;
      padding:10px;background:var(--accent);
      position:sticky;top:72px;z-index:115;
    }
    .topbar button{
      background:#fff;border:2px solid var(--primary);color:var(--primary);
      padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;
      position:relative;
    }
    .topbar button:hover{ background:var(--primary); color:#fff; }
    .cart-count{
      position:absolute;top:-6px;right:-6px;background:red;color:#fff;
      font-size:12px;width:18px;height:18px;border-radius:50%;display:flex;
      align-items:center;justify-content:center;font-weight:700;
    }

    /* ======== CONTROLS ======== */
    .controls{
      display:flex;gap:12px;justify-content:center;align-items:center;
      padding:12px;position:sticky;top:106px;z-index:110;
    }
    .multi-select{ position:relative;width:260px; }
    .multi-select .label{
      display:flex;align-items:center;gap:8px;background:#fff;
      border-radius:8px;padding:8px;border:1px solid #ddd;cursor:pointer;
    }
    .multi-select .panel{
      position:absolute;top:calc(100% + 6px);left:0;right:0;background:#fff;
      border:1px solid #ddd;border-radius:8px;padding:8px;max-height:220px;
      display:none;overflow:auto;z-index:130;box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }

    /* ======== PRODUCT LIST ======== */
    .container{ max-width:1100px;margin:18px auto;padding:0 12px; }
    .table-header{
      display:grid;grid-template-columns:100px 1fr 1fr 90px 110px 120px;
      padding:10px 12px;gap:8px;font-weight:700;color:var(--muted);
      background:linear-gradient(90deg,#fff7f0,#fff3e8);
      border-radius:8px;position:sticky;top:158px;z-index:100;
      box-shadow:0 3px 6px rgba(0,0,0,0.03);
    }
    .category-block{ background:var(--card);padding:10px;border-radius:10px;
      border:1px solid #f2e6db;margin-top:18px; }
    .product{
      display:grid;grid-template-columns:100px 1fr 1fr 90px 110px 120px;
      padding:8px;gap:8px;align-items:center;
    }
    .product + .product { border-top:1px dashed #f0e6db }
    .product img{
      width:76px;height:76px;object-fit:cover;border-radius:8px;border:1px solid #eee;
      cursor:pointer;margin:auto;
    }
    .no-img{
      width:76px;height:76px;border-radius:8px;border:1px solid #eee;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;color:var(--muted);background:#faf5ef;margin:auto;
    }
    .img-preview{
      position:fixed;left:0;top:0;right:0;bottom:0;
      background:rgba(0,0,0,0.8);
      display:none;align-items:center;justify-content:center;
      z-index:300;
    }
    .img-preview img{
      max-width:92%;max-height:92%;border-radius:10px;background:#fff;
    }
.btn-add{
      background:var(--primary);color:#fff;border:none;padding:8px 12px;
      border-radius:8px;font-weight:700;cursor:pointer;
    }
    .btn-ghost{
      background:#fff;border:1px solid #ccc;color:var(--muted);
      padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;
    }
    .btn-ghost:hover{ background:#f5f5f5; }
    .input-full{
      width:100%;padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ddd;
      font-size:14px;
    }
    .qty-input{
      width:72px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center;
    }
/* ======== PANELS ======== */
    .panel{ display:none;position:fixed;right:18px;top:100px;width:420px;
      max-height:78vh;overflow:auto;background:#fff;padding:12px;
      border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:220; }
    .panel.open{ display:block }

    .overlay{ position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.36);
      display:none;z-index:210; }
    .overlay.show{ display:block }
  </style>
</head>
<body>

  <!-- HEADER & RULES -->
  <header>å°å‹åœ˜è³¼ç¶²ç«™</header>
  <div class="rules" id="rules">è¼‰å…¥ä¸­...</div>

  <!-- TOPBAR -->
  <div class="topbar">
    <button id="openWishBtn">ğŸŒ  è¨±é¡˜æ¸…å–®</button>
    <button id="openCartBtn">ğŸ›’ è³¼ç‰©è»Š <span id="cartCount" class="cart-count" style="display:none">0</span></button>
    <button id="openRecordsBtn">ğŸ§¾ è³¼ç‰©ç´€éŒ„</button>
  </div>

  <!-- CONTROLS -->
  <div class="controls container">
    <div class="multi-select" id="categoryMulti">
      <div class="label" id="categoryLabel">åˆ†é¡ç¯©é¸ Â· å¤šé¸ <span id="selectedCount" style="margin-left:auto;color:var(--muted);font-weight:600">å…¨éƒ¨</span></div>
      <div class="panel" id="categoryPanel"></div>
    </div>
    <input id="searchBox" type="text" placeholder="æœå°‹å•†å“åç¨±..." style="padding:8px;border-radius:8px;border:1px solid #ddd;width:320px">
  </div>

  <!-- PRODUCT LIST -->
  <div class="container">
    <div class="table-header">
      <div>åœ–ç‰‡</div><div>åç¨±</div><div>å“ç‰Œ</div><div>åƒ¹æ ¼</div><div>æ•¸é‡</div><div>æ“ä½œ</div>
    </div>
    <div id="productArea"></div>
  </div>

  <!-- è³¼ç‰©è»Š PANEL -->
  <div class="panel" id="cartPanel">
    <form id="orderForm" target="hidden_iframe">
      <h3>è³¼ç‰©è»Š</h3>
      <div id="cartItemsContainer"></div>

      <input type="hidden" name="action" value="submitOrder">
      <input type="hidden" name="cart" id="cartInput">

      <input name="checkoutName" id="checkoutName" placeholder="å§“å" class="input-full">
      <input name="checkoutPhone" id="checkoutPhone" placeholder="é›»è©±" class="input-full">
      <input name="checkoutEmail" id="checkoutEmail" placeholder="Email" class="input-full">

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button type="button" id="closeCart">é—œé–‰</button>
        <button type="submit" class="btn-add">é€å‡ºè¨‚å–®</button>
      </div>
    </form>
  </div>

  <!-- è¨±é¡˜æ¸…å–® PANEL -->
  <div class="panel" id="wishPanel">
    <h3>è¨±é¡˜æ¸…å–® âœ¨</h3>
    <div>
      <input id="wishImg" class="input-full" placeholder="åœ–ç‰‡é€£çµ (é¸å¡«)">
      <input id="wishName" class="input-full" placeholder="ç”¢å“åç¨±">
      <input id="wishPerson" class="input-full" placeholder="è¨±é¡˜äººå§“å">
      <div style="display:flex;justify-content:flex-end;margin-top:4px;gap:8px;">
        <button type="button" class="btn-ghost" id="closeWish">é—œé–‰</button>
        <button type="button" class="btn-add" id="submitWishBtn">é€å‡ºè¨±é¡˜</button>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #f0e0d2;">
    <div id="wishList" style="font-size:14px;color:var(--muted);"></div>
  </div>

  <!-- è³¼è²·ç´€éŒ„ PANEL -->
  <div class="panel" id="recordsPanel">
    <h3>è³¼ç‰©ç´€éŒ„</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <input id="recordsEmail" class="input-full" placeholder="è¼¸å…¥ Email æŸ¥è©¢">
      <button type="button" class="btn-add" id="lookupRecordsBtn" style="white-space:nowrap;">æŸ¥è©¢</button>
    </div>
    <div id="recordsList" style="max-height:400px;overflow:auto;font-size:14px;"></div>
  </div>

  <!-- èƒŒæ™¯é®ç½© -->
  <div class="overlay" id="overlay"></div>

  <!-- IFRAMEï¼ˆé¿å… CORSï¼Œç”¨ä¾†æ¥ GAS å›å‚³è¨Šè™Ÿï¼‰ -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

  <!-- åœ–ç‰‡æ”¾å¤§é è¦½ -->
  <div class="img-preview" id="imgPreview">
    <img src="" alt="é è¦½åœ–ç‰‡">
  </div>


  <!-- =============================
       SCRIPT å€å¡Šï¼ˆJS æ¨¡çµ„åˆ†å±¤ï¼‰
       ============================= -->
  <script>
  /* =====================================================
     CONFIG & GLOBAL STATE
  ===================================================== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzPHf3HfEqTJKgoOmcnuXEJJO24my0sF-yyKwGa_ibmHnTuhgKaHgwZ7c7pFuV43CSl/exec";
  // åœ¨ Apps Script HtmlService / Html viewer ä¸­ï¼Œgoogle.script.run æœƒå­˜åœ¨
  const HAS_GOOGLE_SCRIPT = (typeof google !== "undefined") && google.script && google.script.run;

  // å¾å¾Œç«¯å–å¾—çš„å®Œæ•´å•†å“æ¸…å–®
  let PRODUCTS = [];
  // ç›®å‰å¥—ç”¨æœå°‹ / ç¯©é¸å¾Œè¦é¡¯ç¤ºçš„å•†å“
  let FILTERED_PRODUCTS = [];
  // è³¼ç‰©è»Šå…§å®¹ï¼š[{code,name,price,qty,img,brand,category}]
  let CART = [];
  // è¨±é¡˜æ¸…å–®ï¼ˆé€™è£¡åªåšå‰ç«¯é¡¯ç¤ºï¼ŒçœŸæ­£å¯«å…¥ç”± GAS addWish è² è²¬ï¼‰
  let WISHES = [];
  // ç¯©é¸æ¢ä»¶
  let selectedCategories = new Set();
  let searchKeyword = "";

  /* =====================================================
     INIT
  ===================================================== */
  document.addEventListener("DOMContentLoaded", init);

  function init(){
    console.log("[INIT] å°å‹åœ˜è³¼ç¶²ç«™å•Ÿå‹•");
    bindBaseEvents();
    loadRules();
    loadProducts();
    restoreFromStorage();

    // ç¶å®šåœ–ç‰‡é è¦½é—œé–‰äº‹ä»¶
    const preview = document.getElementById("imgPreview");
    if(preview){
      preview.addEventListener("click", () => {
        preview.style.display = "none";
      });
    }
  }

  /* =====================================================
     API HELPERï¼ˆçµ±ä¸€å‘¼å« GAS Web Appï¼‰
  ===================================================== */
  async function callAPI(payload){
    // å¦‚æœåœ¨ GAS Html ç’°å¢ƒï¼Œå„ªå…ˆä½¿ç”¨ google.script.run ç›´é€£å¾Œç«¯å‡½å¼
    if(HAS_GOOGLE_SCRIPT){
      return new Promise((resolve, reject) => {
        const runner = google.script.run.withFailureHandler(err => {
          console.error("[API][GS] å¾Œç«¯éŒ¯èª¤", err);
          reject(err);
        });

        if(payload.action === "submitOrder"){
          runner.withSuccessHandler(() => {
            resolve({ status:"ok", message:"è¨‚å–®å·²å»ºç«‹ï¼Œæ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼" });
          }).addOrder(payload.order);

        }else if(payload.action === "addWish"){
          runner.withSuccessHandler(() => {
            resolve({ status:"ok", message:"å·²åŠ å…¥è¨±é¡˜æ¸…å–®ï¼" });
          }).addWish(payload.wish);

        }else if(payload.action === "getRecords"){
          runner.withSuccessHandler(records => {
            resolve({ status:"ok", records: records || [] });
          }).getRecords(payload.email);

        }else{
          console.warn("[API][GS] æœªæ”¯æ´çš„ action", payload.action);
          reject(new Error("Unknown action: " + payload.action));
        }
      });
    }

    // ä¸€èˆ¬å¤–éƒ¨ï¼ˆä¾‹å¦‚ GitHub / éœæ…‹ç¶²é ï¼‰ä½¿ç”¨ fetch å‘¼å« Web App
    console.log("[API] POST", GAS_URL, payload);
    let res;
    try{
      res = await fetch(GAS_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }catch(networkErr){
      console.error("[API] ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•é€£ç·šåˆ° GAS", networkErr);
      alert("ç›®å‰ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– GAS Web App æ˜¯å¦å¯ç”¨ã€‚");
      throw networkErr;
    }

    if(!res.ok){
      console.error("[API] HTTP éŒ¯èª¤", res.status, res.statusText);
      alert("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ (" + res.status + ")ï¼Œè«‹ç¢ºèª GAS Web App æ˜¯å¦ç‚ºæœ€æ–°éƒ¨ç½²ï¼Œä¸” URL æ­£ç¢ºã€‚");
      throw new Error("API éŒ¯èª¤: " + res.status);
    }

    const text = await res.text();
    try{
      const json = JSON.parse(text);
      console.log("[API] å›å‚³", json);
      return json;
    }catch(parseErr){
      console.error("[API] å›å‚³ä¸æ˜¯åˆæ³• JSONï¼ŒåŸå§‹å…§å®¹:", text);
      alert("ä¼ºæœå™¨å›å‚³çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºèª doPost æœ‰ä½¿ç”¨ JSON.stringify åŒ…æˆ JSONã€‚");
      throw parseErr;
    }
  }

  async function loadRules(){
    try{
      // åœ¨ Html Viewer / GAS ç’°å¢ƒæ™‚ï¼Œç›´æ¥å‘¼å«å¾Œç«¯å‡½å¼
      if(HAS_GOOGLE_SCRIPT){
        await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(ruleText => {
              document.getElementById("rules").textContent = ruleText || "";
              resolve();
            })
            .withFailureHandler(err => {
              console.error("[RULES][GS] è¼‰å…¥å¤±æ•—", err);
              reject(err);
            })
            .getRules();
        });
        return;
      }

      // ä¸€èˆ¬å¤–éƒ¨ç”¨ Web App doGet
      const res = await fetch(GAS_URL + "?action=getRules");
      if(!res.ok){
        throw new Error("HTTP " + res.status + " " + res.statusText);
      }
      const text = await res.text();
      let data;
      try{
        data = JSON.parse(text);
      }catch(e){
        console.error("[RULES] JSON è§£æå¤±æ•—ï¼ŒåŸå§‹å…§å®¹:", text);
        throw e;
      }
      document.getElementById("rules").textContent = data.rules || "";
    }catch(err){
      console.error("[RULES] è¼‰å…¥å¤±æ•—", err);
      document.getElementById("rules").textContent = "è®€å–è¦å‰‡å¤±æ•—";
    }
  }

  async function loadProducts(){
    const area = document.getElementById("productArea");
    try{
      // åœ¨ Html Viewer / GAS ç’°å¢ƒæ™‚ï¼Œç›´æ¥å‘¼å« getProducts
      if(HAS_GOOGLE_SCRIPT){
        await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(data => {
              PRODUCTS = Array.isArray(data) ? data : [];
              FILTERED_PRODUCTS = PRODUCTS.slice();
              console.log("[PRODUCTS][GS] å–å¾—ç­†æ•¸:", PRODUCTS.length);
              if(!PRODUCTS.length){
                area.innerHTML = "<p style='padding:12px;'>ç›®å‰æ²’æœ‰å•†å“è³‡æ–™ï¼ˆè«‹ç¢ºèª GAS getProducts æ˜¯å¦æœ‰è³‡æ–™ï¼‰ã€‚</p>";
              }else{
                buildCategoryFilter();
                renderProducts();
              }
              resolve();
            })
            .withFailureHandler(err => {
              console.error("[PRODUCTS][GS] è¼‰å…¥å¤±æ•—", err);
              reject(err);
            })
            .getProducts();
        });
        return;
      }

      // ä¸€èˆ¬å¤–éƒ¨ç”¨ Web App doGet
      console.log("[PRODUCTS] è¼‰å…¥ä¸­...", GAS_URL + "?action=getProducts");
      const res = await fetch(GAS_URL + "?action=getProducts");
      if(!res.ok){
        console.error("[PRODUCTS] HTTP éŒ¯èª¤", res.status, res.statusText);
        throw new Error("HTTP " + res.status + " " + res.statusText);
      }
      const text = await res.text();
      let data;
      try{
        data = JSON.parse(text);
      }catch(parseErr){
        console.error("[PRODUCTS] JSON è§£æå¤±æ•—ï¼ŒåŸå§‹å…§å®¹:", text);
        throw parseErr;
      }

      PRODUCTS = Array.isArray(data) ? data : (data.products || []);
      FILTERED_PRODUCTS = PRODUCTS.slice();
      console.log("[PRODUCTS] å–å¾—ç­†æ•¸:", PRODUCTS.length);

      if(!PRODUCTS.length){
        area.innerHTML = "<p style='padding:12px;'>ç›®å‰æ²’æœ‰å•†å“è³‡æ–™ï¼ˆè«‹ç¢ºèª GAS getProducts æ˜¯å¦æœ‰å›å‚³é™£åˆ—ï¼‰ã€‚</p>";
        return;
      }

      buildCategoryFilter();
      renderProducts();
    }catch(err){
      console.error("[PRODUCTS] è¼‰å…¥å¤±æ•—", err);
      if(area){
        area.innerHTML = "<p style='padding:12px;color:#c00;'>å•†å“è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚<br>è«‹ç¢ºèª GAS Web App URL æ­£ç¢ºï¼Œä¸” doGet(action=getProducts) æœ‰å›å‚³åˆæ³• JSONã€‚</p>";
      }
    }
  }

  /* =====================================================
     EVENT ç¶å®šï¼ˆTopbar / é¢æ¿ / æœå°‹ / è¡¨å–®ï¼‰
  ===================================================== */
  function bindBaseEvents(){
    const overlay = document.getElementById("overlay");

    // é–‹å•Ÿ / é—œé–‰è³¼ç‰©è»Š
    document.getElementById("openCartBtn").onclick = () => {
      renderCart();
      openPanel("cartPanel");
    };
    document.getElementById("closeCart").onclick = () => closePanel("cartPanel");

    // è¨±é¡˜æ¸…å–® panel
    document.getElementById("openWishBtn").onclick = () => openPanel("wishPanel");
    document.getElementById("closeWish").onclick = () => closePanel("wishPanel");

    // è³¼ç‰©ç´€éŒ„ panel
    document.getElementById("openRecordsBtn").onclick = () => openPanel("recordsPanel");

    // é»æ“Šé®ç½©é—œé–‰æ‰€æœ‰ panel
    overlay.onclick = closeAllPanels;

    // æœå°‹è¼¸å…¥æ¡†
    document.getElementById("searchBox").addEventListener("input", e => {
      searchKeyword = e.target.value.trim();
      applyFilters();
    });

    // åˆ†é¡å¤šé¸ label æ‰“é–‹ / é—œé–‰æ¸…å–®
    document.getElementById("categoryLabel").addEventListener("click", () => {
      const panel = document.getElementById("categoryPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    });

    // å•†å“å€ï¼šäº‹ä»¶å§”æ´¾ï¼ˆåŠ å…¥è³¼ç‰©è»Šã€åœ–ç‰‡æ”¾å¤§ï¼‰
    document.getElementById("productArea").addEventListener("click", e => {
      if(e.target.matches("button[data-add]")){
        const code = e.target.dataset.add;
        handleAddToCart(code);
        return;
      }
      if(e.target.matches(".product img")){
        showImagePreview(e.target.src);
        return;
      }
    });

    // è¨‚å–®è¡¨å–® submit
    document.getElementById("orderForm").addEventListener("submit", e => {
      e.preventDefault();
      submitOrder();
    });

    // è¨±é¡˜æ¸…å–®é€å‡º
    document.getElementById("submitWishBtn").onclick = submitWish;

    // è³¼ç‰©ç´€éŒ„æŸ¥è©¢
    document.getElementById("lookupRecordsBtn").onclick = lookupRecords;
  }

  /* =====================================================
     PANEL é–‹é—œ
  ===================================================== */
  function openPanel(id){
    document.getElementById(id).classList.add("open");
    document.getElementById("overlay").classList.add("show");
  }
  function closePanel(id){
    document.getElementById(id).classList.remove("open");
    if(!document.querySelector(".panel.open")){
      document.getElementById("overlay").classList.remove("show");
    }
  }
  function closeAllPanels(){
    document.querySelectorAll(".panel.open").forEach(p => p.classList.remove("open"));
    document.getElementById("overlay").classList.remove("show");
  }

  /* =====================================================
     åˆ†é¡ç¯©é¸ + æœå°‹
  ===================================================== */
  function buildCategoryFilter(){
    const panel = document.getElementById("categoryPanel");
    const cats = [...new Set(PRODUCTS.map(p => p.category).filter(Boolean))].sort();
    if(!cats.length){
      panel.innerHTML = "<div style='font-size:13px;color:var(--muted)'>ç›®å‰æ²’æœ‰åˆ†é¡</div>";
      return;
    }
    panel.innerHTML = cats.map(cat => `
      <label style="display:flex;align-items:center;gap:6px;padding:4px 2px;font-size:14px;">
        <input type="checkbox" value="${cat}"> ${cat}
      </label>
    `).join("");

    panel.addEventListener("change", e => {
      if(e.target.matches("input[type='checkbox']")){
        const val = e.target.value;
        if(e.target.checked) selectedCategories.add(val);
        else selectedCategories.delete(val);
        updateSelectedCategoryLabel();
        applyFilters();
      }
    });
  }

  function updateSelectedCategoryLabel(){
    const labelSpan = document.getElementById("selectedCount");
    if(!selectedCategories.size){
      labelSpan.textContent = "å…¨éƒ¨";
    }else{
      labelSpan.textContent = `å·²é¸ ${selectedCategories.size}`;
    }
  }

  function applyFilters(){
    FILTERED_PRODUCTS = PRODUCTS.filter(p => {
      // åˆ†é¡
      if(selectedCategories.size && !selectedCategories.has(p.category)) return false;
      // æœå°‹
      if(searchKeyword){
        const kw = searchKeyword.toLowerCase();
        const name = (p.name || "").toLowerCase();
        const brand = (p.brand || "").toLowerCase();
        if(!name.includes(kw) && !brand.includes(kw)) return false;
      }
      return true;
    });
    renderProducts();
  }

  /* =====================================================
     å•†å“æ¸²æŸ“
  ===================================================== */
  function renderProducts(){
    const area = document.getElementById("productArea");
    area.innerHTML = "";
    if(!FILTERED_PRODUCTS.length){
      area.innerHTML = "<p style='padding:12px;'>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“ã€‚</p>";
      return;
    }

    // ä¾åˆ†é¡ç¾¤çµ„
    const byCat = {};
    FILTERED_PRODUCTS.forEach(p => {
      const c = p.category || "æœªåˆ†é¡";
      if(!byCat[c]) byCat[c] = [];
      byCat[c].push(p);
    });

    Object.keys(byCat).sort().forEach(cat => {
      const block = document.createElement("div");
      block.className = "category-block";

      const title = document.createElement("h4");
      title.textContent = cat;
      title.style.margin = "4px 0 8px";
      block.appendChild(title);

      byCat[cat].forEach(p => {
        const row = document.createElement("div");
        row.className = "product";
        const imgCell = p.img
          ? `<img src="${p.img}" alt="${p.name || "å•†å“"}">`
          : `<div class="no-img">ç„¡åœ–ç‰‡</div>`;
        row.innerHTML = `
          <div>
            ${imgCell}
          </div>
          <div>${p.name || "æœªå‘½åå•†å“"}</div>
          <div>${p.brand || "-"}</div>
          <div>$${formatMoney(p.price || 0)}</div>
          <div>
            <input type="number" min="1" value="1" class="qty-input" data-code="${p.code}">
          </div>
          <div style="text-align:center;">
            <button class="btn-add" data-add="${p.code}">åŠ å…¥</button>
          </div>
        `;
        block.appendChild(row);
      });

      area.appendChild(block);
    });
  }

  /* =====================================================
     è³¼ç‰©è»Šï¼šæ–°å¢ / æ¸²æŸ“ / æ•¸é‡å¾½ç« 
  ===================================================== */
  function handleAddToCart(code){
    const product = PRODUCTS.find(p => p.code === code);
    if(!product) return;
    const qtyInput = document.querySelector(`input.qty-input[data-code="${code}"]`);
    const qty = parseInt(qtyInput && qtyInput.value, 10) || 1;

    let item = CART.find(i => i.code === code);
    if(item){
      item.qty += qty;
    }else{
      item = {
        code: product.code,
        name: product.name,
        brand: product.brand,
        price: Number(product.price) || 0,
        img: product.img,
        category: product.category,
        qty
      };
      CART.push(item);
    }
    console.log("[CART] å·²åŠ å…¥", item);
    updateCartCount();
    saveToStorage();
  }

  function formatMoney(value){
    const n = Number(value) || 0;
    return n.toFixed(2); // å…¨ç«™çµ±ä¸€ç‚ºå°æ•¸é»å¾Œå…©ä½
  }

  function renderCart(){

    const box = document.getElementById("cartItemsContainer");
    if(!box) return;

    if(!CART.length){
      box.innerHTML = "<p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>";
      updateCartCount();
      return;
    }

    let total = 0;
    box.innerHTML = CART.map(item => {
      const sub = item.price * item.qty; // åŸå§‹æ•¸å­—ï¼Œé¡¯ç¤ºæ™‚å†ç”¨ formatMoney è™•ç†
      total += sub;
      const imgCell = item.img
        ? `<img src="${item.img}" class="cart-img" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">`
        : `<div class="no-img" style="width:50px;height:50px;font-size:11px;">ç„¡åœ–ç‰‡</div>`;
      return `
        <div class="cart-item" data-code="${item.code}" style="display:flex;gap:8px;margin-bottom:8px;background:#fff8f3;border-radius:8px;padding:6px;">
          ${imgCell}
          <div style="flex:1;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="font-weight:600;">${item.name}</span>
              <button type="button" class="btn-ghost btn-remove" style="border:none;color:red;background:none;">åˆªé™¤</button>
            </div>
            <div style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-top:2px;">
              <span>æ•¸é‡</span>
              <input type="number" min="1" value="${item.qty}" class="cart-qty" style="width:60px;">
              <span>å°è¨ˆ $${formatMoney(sub)}</span>
            </div>
          </div>
        </div>
      `;
    }).join("") + `
      <div style="text-align:right;font-weight:700;margin-top:4px;">ç¸½è¨ˆï¼š$${formatMoney(total)}</div>
    `;

    // ç¶å®šåˆªé™¤èˆ‡æ•¸é‡è®Šæ›´
    box.querySelectorAll(".btn-remove").forEach(btn => {
      btn.onclick = () => {
        const code = btn.closest(".cart-item").dataset.code;
        CART = CART.filter(i => i.code !== code);
        renderCart();
        updateCartCount();
        saveToStorage();
      };
    });

    box.querySelectorAll(".cart-qty").forEach(input => {
      input.onchange = () => {
        const code = input.closest(".cart-item").dataset.code;
        const item = CART.find(i => i.code === code);
        if(!item) return;
        const v = parseInt(input.value,10) || 1;
        item.qty = v;
        renderCart();
        updateCartCount();
        saveToStorage();
      };
    });

    // é»è³¼ç‰©è»Šå…§çš„åœ–ç‰‡ä¹Ÿå¯ä»¥æ”¾å¤§é è¦½
    box.querySelectorAll(".cart-img").forEach(img => {
      img.onclick = () => showImagePreview(img.src);
    });
  }

  function updateCartCount(){
    const count = CART.reduce((s,i)=>s+i.qty,0);
    const el = document.getElementById("cartCount");
    if(count>0){
      el.style.display = "flex";
      el.textContent = count;
    }else{
      el.style.display = "none";
    }
  }

  function saveToStorage(){
    try{
      localStorage.setItem("groupbuy_cart", JSON.stringify(CART));
    }catch(e){ console.warn("localStorage å¯«å…¥å¤±æ•—", e); }
  }

  function restoreFromStorage(){
    try{
      const raw = localStorage.getItem("groupbuy_cart");
      if(raw){
        CART = JSON.parse(raw) || [];
        updateCartCount();
      }
    }catch(e){ console.warn("localStorage è®€å–å¤±æ•—", e); }
  }

  /* =====================================================
     è¨‚å–®é€å‡º
  ===================================================== */
  async function submitOrder(){
    if(!CART.length){
      alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
      return;
    }
    const name = document.getElementById("checkoutName").value.trim();
    const phone = document.getElementById("checkoutPhone").value.trim();
    const email = document.getElementById("checkoutEmail").value.trim();
    if(!name || !phone || !email){
      alert("è«‹å®Œæ•´å¡«å¯«å§“åã€é›»è©±èˆ‡ Email");
      return;
    }
    const payload = {
      action:"submitOrder",
      order:{ name, phone, email, cart: CART }
    };
    try{
      const res = await callAPI(payload);
      alert(res.message || "è¨‚å–®å·²é€å‡ºï¼Œæ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼");
      CART = [];
      saveToStorage();
      renderCart();
      updateCartCount();
      closePanel("cartPanel");
    }catch(err){
      console.error("[ORDER] é€å‡ºå¤±æ•—", err);
      alert("è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  /* =====================================================
     è¨±é¡˜æ¸…å–®
  ===================================================== */
  async function submitWish(){
    const img = document.getElementById("wishImg").value.trim();
    const name = document.getElementById("wishName").value.trim();
    const person = document.getElementById("wishPerson").value.trim();
    if(!name || !person){
      alert("è«‹å¡«å¯«ç”¢å“åç¨±èˆ‡è¨±é¡˜äººå§“å");
      return;
    }
    const wish = { img, name, person };
    try{
      const res = await callAPI({ action:"addWish", wish });
      alert(res.message || "å·²é€å‡ºè¨±é¡˜ ğŸ™Œ");
      WISHES.push(wish);
      renderWishes();
      document.getElementById("wishImg").value = "";
      document.getElementById("wishName").value = "";
      document.getElementById("wishPerson").value = "";
    }catch(err){
      console.error("[WISH] é€å‡ºå¤±æ•—", err);
      alert("è¨±é¡˜é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  function renderWishes(){
    const box = document.getElementById("wishList");
    if(!WISHES.length){
      box.innerHTML = "<p>ç›®å‰æ²’æœ‰è¨±é¡˜ç´€éŒ„ï¼ˆæœ¬å€åªé¡¯ç¤ºæœ¬æ¬¡ç€è¦½æœŸé–“é€å‡ºçš„è¨±é¡˜ï¼‰ã€‚</p>";
      return;
    }
    box.innerHTML = WISHES.map(w => `
      <div style="margin-bottom:6px;">
        <div><b>${w.name}</b></div>
        <div style="font-size:13px;color:var(--muted);">${w.person}</div>
      </div>
    `).join("");
  }

  function showImagePreview(src){
    const box = document.getElementById("imgPreview");
    if(!box) return;
    const img = box.querySelector("img");
    img.src = src;
    box.style.display = "flex";
  }

  /* =====================================================
     è³¼ç‰©ç´€éŒ„æŸ¥è©¢
  ===================================================== */
  async function lookupRecords(){
    const email = document.getElementById("recordsEmail").value.trim();
    if(!email){
      alert("è«‹å…ˆè¼¸å…¥ Email");
      return;
    }
    try{
      const res = await callAPI({ action:"getRecords", email });
      renderRecords(res.records || []);
    }catch(err){
      console.error("[RECORDS] æŸ¥è©¢å¤±æ•—", err);
      alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  function renderRecords(list){
    const box = document.getElementById("recordsList");
    if(!list.length){
      box.innerHTML = "<p>æŸ¥ç„¡ç´€éŒ„</p>";
      return;
    }
    box.innerHTML = list.map(r => `
      <div style="background:#fff8f3;border-radius:8px;padding:6px;margin-bottom:6px;border:1px solid #f2e6db;">
        <div><b>${r.date || ""}</b></div>
        <div style="font-size:13px;color:var(--muted);">${r.items || ""}</div>
      </div>
    `).join("");
  }

  </script>
</body>
</html>
